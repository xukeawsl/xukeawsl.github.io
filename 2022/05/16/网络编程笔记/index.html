<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>网络编程笔记 | NumPy's Blog</title><meta name="keywords" content="socket"><meta name="author" content="NumPy,xukeawsl@gmail.com"><meta name="copyright" content="NumPy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网络编程IPv4 套接字地址结构它以 sockaddr_in 命名，定义在 &lt;netinet&#x2F;in.h&gt; 头文件中，POSIX 定义如下： struct in_addr &amp;#123;     in_addr_t s_addr;	&#x2F;* 32-bit IPv4 address *&#x2F; &amp;#125;;  struct sockaddr_in &amp;#123;   	uint8_t sin_len;">
<meta property="og:type" content="article">
<meta property="og:title" content="网络编程笔记">
<meta property="og:url" content="https://xukeawsl.gitee.io/2022/05/16/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="NumPy&#39;s Blog">
<meta property="og:description" content="网络编程IPv4 套接字地址结构它以 sockaddr_in 命名，定义在 &lt;netinet&#x2F;in.h&gt; 头文件中，POSIX 定义如下： struct in_addr &amp;#123;     in_addr_t s_addr;	&#x2F;* 32-bit IPv4 address *&#x2F; &amp;#125;;  struct sockaddr_in &amp;#123;   	uint8_t sin_len;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2022/05/16/frVxQGFPMW6UtpI.png">
<meta property="article:published_time" content="2022-05-16T09:31:55.000Z">
<meta property="article:modified_time" content="2022-05-16T10:04:40.477Z">
<meta property="article:author" content="NumPy">
<meta property="article:tag" content="socket">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/05/16/frVxQGFPMW6UtpI.png"><link rel="shortcut icon" href="/img/N.png"><link rel="canonical" href="https://xukeawsl.gitee.io/2022/05/16/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '网络编程笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2022-05-16 18:04:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="/live2d-widget/autoload.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/11/23/kxpMnNjGaOhZews.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/05/16/qucopzeACxrjSik.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">NumPy's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网络编程笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-05-16T09:31:55.000Z" title="Created 2022-05-16 17:31:55">2022-05-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-16T10:04:40.477Z" title="Updated 2022-05-16 18:04:40">2022-05-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/socket/">socket</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">29.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>119min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="网络编程笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h1><h2 id="IPv4-套接字地址结构"><a href="#IPv4-套接字地址结构" class="headerlink" title="IPv4 套接字地址结构"></a>IPv4 套接字地址结构</h2><p>它以 <code>sockaddr_in</code> 命名，定义在 <code>&lt;netinet/in.h&gt;</code> 头文件中，POSIX 定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>	<span class="token comment">/* 32-bit IPv4 address */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">&#123;</span>
  	<span class="token class-name">uint8_t</span> sin_len<span class="token punctuation">;</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span>		<span class="token comment">/* AF_INET */</span>
    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>			<span class="token comment">/* 16-bit TCP or UDP port number */</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>	<span class="token comment">/* 32-bit IPv4 address */</span>
    <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">/* unused */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>POSIX 规范只需要这个结构中的3个字段：<code>sin_family</code> 、<code>sin_addr</code>  和 <code>sin_port</code> 。</p>
<p><img src="https://s2.loli.net/2022/05/16/BUIFTAhgKlawvcz.png" alt="image-20210819155132202.png"></p>
<ul>
<li><code>sin_zero</code> 字段未曾使用，不过在填写这种套接字地址结构时，我们总是把该字段置为 0。按照惯例，我们总是在填写前把整个结构置为 0，而不是单单把 <code>sin_zero</code> 字段置为 0。（尽管多数使用该结构的情况不要求这一字段为0，但是当捆绑一个非通配的 IPv4 地址时，该字段必须为 0)</li>
<li>套接字地址结构仅在给定主机上使用：虽然结构中的某些字段（例如 IP 地址和端口号）用在不同主机之间的通信中，但是<strong>结构本身并不在主机之间传递</strong></li>
</ul>
<h2 id="通用套接字地址结构"><a href="#通用套接字地址结构" class="headerlink" title="通用套接字地址结构"></a>通用套接字地址结构</h2><p>​    当作为一个参数传递进任何套接字函数时，套接字地址结构总是以引用形式（也就是以指向该结构的指针）来传递。然而以这样的指针作为参数之一的任何套接字函数必须处理来自所支持的任何协议族的套接字地址</p>
<p>​    在如何声明所传递指针的数据类型上存在一个问题。有了 ANSI C 后解决办法很简单：<code>void*</code> 是通用的指针类型。然而套接字函数是在 ANSI C之前定义的，在1982年采取的办法是在 <code>&lt;sys/socket.h&gt;</code> 头文件中定义一个通用的套接字地址结构</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">uint8_t</span> sa_len<span class="token punctuation">;</span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>	<span class="token comment">/* address family : AF_xxx value */</span>
    <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">/* protocol-specific address */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>​    于是套接字函数被定义为以指向某个通用套接字地址结构的一个指针作为其参数之一，正如bind函数的ANSI C函数原型所示：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">socklen_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    这就要求对这些函数的任何调用都必须要将指向特定于协议的套接字地址结构的指针进行类型强制转换，变成指向某个通用套接字地址结构的指针，例如：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serv<span class="token punctuation">;</span>

<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    如果我们省略了其中的类型强制类型转换部分并假设系统的头文件中有 <code>bind</code> 函数的一个ANSI C原型，那么 C 编译器就会产生警告：把不兼容的指针类型传递给 <code>bind</code> 函数的第二个参数</p>
<p>​    从内核的角度看，使用指向通用套接字地址结构的指针另有原因：内核必须取调用者的指针，把它类型强制转换为 <code>struct sockaddr *</code> 类型，然后检查其中 <code>sa_family</code> 字段的值来确定这个结构的真实类型。然而从应用程序开发人员的角度看，要是 <code>void *</code> 这个指针类型可用那就更简单了，因为无须显式进行类型强制转换</p>
<h2 id="IPv6-套接字地址结构"><a href="#IPv6-套接字地址结构" class="headerlink" title="IPv6 套接字地址结构"></a>IPv6 套接字地址结构</h2><p>IPv6套接字地址结构在 <code>&lt;netinet/in.h&gt;</code> 头文件中定义</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">uint8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIN6_LEN</span>	<span class="token comment">/* required for complie-time tests */</span></span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> sin6_len<span class="token punctuation">;</span>				<span class="token comment">/* length of this struct (28) */</span>
    <span class="token class-name">sa_family_t</span> sin6_famliy<span class="token punctuation">;</span>		<span class="token comment">/* AF_INET6 */</span>
    <span class="token class-name">in_port_t</span> sin6_port<span class="token punctuation">;</span>			<span class="token comment">/* transport layer port# */</span>
    
    <span class="token class-name">uint32_t</span> sin6_flowinfo<span class="token punctuation">;</span>			<span class="token comment">/* flow information, undefined */</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span>		<span class="token comment">/* IPv6 address */</span>
    
    <span class="token class-name">uint32_t</span> sin6_scope_id<span class="token punctuation">;</span>			<span class="token comment">/* set of interfaces for a scope */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ul>
<li>如果系统支持套接字地址结构中的长度字段，那么 <code>SIN6_LEN</code> 常值必须定义</li>
<li>IPv6 的地址族是 <code>AF_INET6</code> ，而 IPv4 的地址族 <code>AF_INET</code> </li>
<li>结构中字段的先后顺序做过编排，使得如果 <code>sockaddr_in6</code> 结构本身是64位对齐的，那么128位的 <code>sin6_addr</code> 字段也是64位对齐的。在一些64位处理机上，如果64位数据存储在某个64位边界位置，那么对它的访问将得到优化处理</li>
<li><code>sin6_flowinfo</code> 字段分成两个字段：<ul>
<li>低序20位是流标（flow label）</li>
<li>高序12位保留</li>
</ul>
</li>
</ul>
<h2 id="新的通用套接字地址结构"><a href="#新的通用套接字地址结构" class="headerlink" title="新的通用套接字地址结构"></a>新的通用套接字地址结构</h2><p>​    作为 IPv6 套接字 API 的一部分而定义的新的通用套接字地址结构克服了现有 <code>struct sockaddr</code> 的一些缺点。不像 <code>struct sockaddr</code> ，新的 <code>struct sockaddr_storage</code> 足以容纳系统所支持的任何套接字地址结构。<code>sockaddr_storage</code> 结构在 <code>&lt;netinet/in.h&gt;</code> 头文件中定义：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">uint8_t</span> ss_len<span class="token punctuation">;</span>
    <span class="token class-name">sa_family_t</span> ss_family<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>​    <code>sockaddr_storage</code> 类型提供的通用套接字地址结构相比 <code>sockaddr</code> 存在以下两点差别：</p>
<p>(1) 如果系统支持的任何套接字地址结构有对齐需要，那么 <code>sockaddr_storage</code> 能够满足最苛刻的对齐要求</p>
<p>(2) <code>sockaddr_storage</code> 足够大，能够容纳系统支持的任何套接字地址结构（注意：除了 <code>ss_family</code> 和 <code>ss_len</code> 外，<code>sockaddr_storage</code> 结构中的其他字段对用户来说是透明的。<code>sockaddr_storage</code> 结构必须类型强制转换成或复制到适合于 <code>ss_family</code> 字段所给出的地址类型的套接字地址结构中，才能访问其他字段）</p>
<p><img src="https://s2.loli.net/2022/05/16/QC8TjkmKZanLxHy.png" alt="image-20210819163413042.png"></p>
<h2 id="值-结果参数"><a href="#值-结果参数" class="headerlink" title="值-结果参数"></a>值-结果参数</h2><p>（1）从进程到内核传递套接字地址结构的函数有3个：<code>bind</code> 、<code>connect</code> 和 <code>sendto</code> 。这些函数的一个参数是指向某个套接字地址结构的指针，另一个参数是该结构的整数大小，如：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    既然指针和指针所指内容的大小都传递给了内核，于是内核知道到底需要从进程复制多少数据进来</p>
<p><img src="https://s2.loli.net/2022/05/16/nLyG4NVwjpPoQuE.png" alt="image-20210819163904201.png"></p>
<p>（2）从内核到进程传递套接字地址结构的函数有4个：<code>accept</code> 、<code>recvfrom</code> 、<code>getsockname</code> 和 <code>getpeername</code> 。这4个函数的其中两个参数是指向某个套接字地址结构的指针和指向表示该结构大小的整数变量的指针，如：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> cli<span class="token punctuation">;</span>			<span class="token comment">/* Unix domain */</span>
<span class="token class-name">socklen_t</span> len<span class="token punctuation">;</span>

len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cli<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* len is a value */</span>
<span class="token function">getpeername</span><span class="token punctuation">(</span>unixfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cli<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* len may have changed */</span></code></pre>

<p>把套接字地址结构大小这个参数从一个整数改为指向某个整数变量的指针，其原因在于：当函数被调用时，结构大小是一个值（value），它告诉内核该结构的大小，这样内核在写该结构时不至于越界；当函数返回时，结构大小又是一个结果（result），它告诉进程内核在该结构中究竟存储了多少信息。这种类型的参数称为值-结果参数</p>
<p><img src="https://s2.loli.net/2022/05/16/QMdIPA5nyG9Blb6.png" alt="image-20210819164624835.png"></p>
<p>传递套接字地址结构的函数还有两个：<code>recvmsg</code> 和 <code>sendmsg</code> ，它们套接字地址结构的长度不是作为函数参数而是作为结构字段传递的</p>
<p>​    当使用值-结果参数作为套接字地址结构的长度时，如果套接字地址结构是固定长度的，那么从内核返回的值总是那个固定长度，例如 IPv4 的 <code>sockaddr_in</code> 长度是16，IPv6的 <code>sockaddr_in6</code> 长度是28。然而对于可变长度的套接字地址结构（如 Unix域的 <code>sockaddr_un</code> ），返回值可能小于该结构的最大长度</p>
<h2 id="字节排序函数"><a href="#字节排序函数" class="headerlink" title="字节排序函数"></a>字节排序函数</h2><p>​    考虑一个16位整数，它由2个字节组成。内存中存储这两个字节有两种方法：一种是将低序字节存储在起始地址，这称为<strong>小端字节序</strong>；另一种方法是将高序字节存储在起始地址，这称为<strong>大端字节序</strong></p>
<p><img src="https://s2.loli.net/2022/05/16/GwdTeEzkVJxtOWy.png" alt="image-20210819165532098.png"></p>
<p>​    遗憾的是，这两种字节序之间没有标准可循，两种格式都有系统使用。我们把某个给定系统所用的字节序称为<strong>主机字节序</strong>，输出主机字节序程序如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">short</span> s<span class="token punctuation">;</span>
        <span class="token keyword">char</span> c<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> un<span class="token punctuation">;</span>
    
    un<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0x0102</span><span class="token punctuation">;</span>	<span class="token comment">// 小端: 0x01 &lt;- 0x02</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"big-endian\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"little-endian\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> 
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"unknown\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sizeof(short) = %d\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>​    既然网络协议必须制定一个网络字节序，作为网络编程人员的我们必须清楚不同字节序之间的差异。举例来说，在每个TCP分节中都有16位的端口号和32位的IPv4地址。发送协议栈和接收协议栈必须就这些多字节字段各个字节的传送顺序达成一致。<strong>网际协议使用大端字节序来传送这些多字节整数</strong></p>
<p>​    从理论上说，具体实现可以按主机字节序存储套接字地址结构中的各个字段，等到需要在这些字段和协议首部相应字段之间移动时，再在主机字节序和网络字节序之间进行互转，让我们免于操心转换细节。然而由于历史的原因和 POSIX 规范的规定，<strong>套接字地址结构中的某些字段必须按照网络字节序进行维护</strong>。因此我们要关注如何在<strong>主机字节序和网络字节序之间相互转换</strong>。这两种字节序之间的转换使用以下 4 个函数：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>

<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> host16bitvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> host32bitvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 均返回：网络字节序的值</span>

<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> net16bitvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> net32bitvalue<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 均返回：主机字节序的值</span></code></pre>

<p>​    在这些函数的名字中，h 代表 host，n 代表 network，s 代表 short，l 代表 long。当使用这些函数时，我们并不关心主机字节序和网络字节序的真实值。我们所要做的只是调用适当的函数在主机和网络字节序之间转换某个给定值。在那些与网络协议所用字节序（大端）相同的系统中，这四个函数通常被定义为空宏</p>
<h2 id="字节操纵函数"><a href="#字节操纵函数" class="headerlink" title="字节操纵函数"></a>字节操纵函数</h2><p>​    操纵多字节字段的函数有两组，它们既不对数据作解释，也不假设是以空字符结束的C字符串。当处理套接字地址结构时，我们需要对这些类型的函数，因为我们需要操纵诸如IP地址这样的字段，这些字段可能包含值为 0 的字节，却并不是 C 字符串。</p>
<p>​    名字以 <code>b</code> （表示字节）开头的第一组函数起源于4.2BSD，几乎所有现今支持套接字函数的系统仍然提供它们。名字以 <code>mem</code> （表示内存）开头的第二组函数起源于 ANSI C标准，支持 ANSI C 函数库的所有系统都提供它们</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h></span></span>

<span class="token keyword">void</span> <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">bcopy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">bcmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr2<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 相等返回0</span></code></pre>

<p><code>bzero</code> 把目标字节串中指定数目的字节置为0。我们经常使用该函数来把一个套接字地址结构初始化为0。<code>bcopy</code> 将指定数目的字节从源字节串移到目标字节串。<code>bcmp</code> 比较两个任意的字节串，若相同则返回0，否则返回值非负</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">memcmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr2<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>memset</code> 把目标字节串指定数目的字节置为c。<code>memset</code> 类似 <code>bcopy</code> ，不过两个指针参数的顺序是相反的。当源字节串与目标字节串重叠时，<code>bcopy</code> 能够正确处理，但是 <code>memcpy</code>  的操作结果却不可知。这种情形下必须改用 ANSI C 的 <code>memmove</code> 函数</p>
<p><code>memcpy</code> 比较两个任意的字节串，若相同则返回 0，否则返回一个非 0 值，是大于 0 还是小于 0 取决于第一个不等的字节：如果 <code>ptr1</code> 所指的字节串中的这个字节大于 <code>ptr2</code> 所指字节中对应字节，那么大于 0，否则小于 0。我们的比较操作是在假设两个不等的字节均为无符号字符的前提下完成的</p>
<h2 id="inet-aton、inet-addr-和-inet-ntoa-函数"><a href="#inet-aton、inet-addr-和-inet-ntoa-函数" class="headerlink" title="inet_aton、inet_addr 和 inet_ntoa 函数"></a>inet_aton、inet_addr 和 inet_ntoa 函数</h2><p>（1）<code>inet_aton</code> 、<code>inet_addr</code> 和 <code>inet_ntoa</code> 在点分十进制数串（例如“206.168.112.96”）与它长度为 32 位的网络字节序二进制值间转换 IPv4 地址</p>
<p>（2）两个比较新的函数 <code>inet_pton</code> 和 <code>inet_ntop</code> 对于 IPv4 地址和 IPv6 地址都适用</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token comment">// 返回：若字符串有效则为1，否则为0</span>
<span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>addrptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若字符串有效则为32位二进制网络字节序的IPv4地址，否则为INADDR_NONE（被废弃）</span>
<span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：指向一个点分十进制数串的指针</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> inaddr<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>如今 <code>inet_addr</code> 已被废弃，新的代码应该改用 <code>inet_aton</code> 函数。更好的办法是使用下一节中介绍的新函数，它们对于 IPv4 和 IPV6 都使用</p>
<p><code>inet_ntoa</code> 函数将一个 32 位的网络字节序二进制 IPv4 地址转换成相应的点分十进制数串。由该函数的返回值所指向的字符串驻留在<strong>静态内存</strong>中。这意味着该函数是<strong>不可重入</strong>的（注意：该函数以一个结构而不是以指向该结构的一个指针作为其参数）</p>
<h2 id="inet-pton-和-inet-ntop-函数"><a href="#inet-pton-和-inet-ntop-函数" class="headerlink" title="inet_pton 和 inet_ntop 函数"></a>inet_pton 和 inet_ntop 函数</h2><p>这两个函数是随 IPv6 出现的新函数，对于 IPv4 和 IPv6 地址都适用。函数名中 p 和 n分别代表 <strong>表达（presentation）</strong>和 <strong>数值（numeric）</strong>。地址的表达格式通常是 ASCII 字符串，数值格式则是存放到套接字地址结构中的二进制值</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token comment">// 返回：若成功则为 1，若输入不是有效的表达式格式则为 0，若出错则为 -1</span>
<span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回：若成功则为指向结果的指针，若出错则为NULL</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>这两个函数的 family 参数既可以是 <code>AF_INET</code> ，也可以是 <code>AF_INET6</code> 。如果以不被支持的地址族作为 family 参数，这两个函数就都返回一个错误，并将 <code>errno </code> 置为 <code>EAFNOSUPPORT</code> </p>
<p>第一个函数尝试转换由 <code>strptr </code> 指针所指的字符串，并通过 <code>addrptr</code> 指针存放二进制结果。若成功则返回值为1，否则如果对所指定的 family 而言输入的字符串不是有效的表达式格式，那么返回值为 0</p>
<p><code>inet_ntop</code> 进行相反的转换，从数值格式（addrptr）转换到表达格式（strptr）。len 参数是目标存储单元的大小，以免该函数溢出其调用者的缓冲区。为有助于指定这个大小，在 <code>&lt;neinet/in.h&gt;</code> 头文件中有如下定义：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INET_ADDRSTRLEN</span> <span class="token expression"><span class="token number">16</span> 		</span><span class="token comment">/* for IPv4 dotted-decimal */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INET6_ADDRSTRLEN</span> <span class="token expression"><span class="token number">46</span>     </span><span class="token comment">/* for IPv6 hex string */</span></span></code></pre>

<p>如果len太小，不足以容纳表达格式结果（包括结尾的空字符），那么返回一个空指针，并置 <code>errno</code> 为 <code>ENOSPC</code> </p>
<p><code>inet_ntop</code> 函数的 strptr 参数不可以是一个空指针。调用者必须为目标存储单元分配内存并指定其大小。调用成功时，这个指针就是该函数的返回值</p>
<p><img src="https://s2.loli.net/2022/05/16/5g4KjB72uaw8m1p.png" alt="image-20210819183416434.png"></p>
<p>示例：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 两种方式</span>
foo<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>foo<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 推荐</span>


<span class="token comment">// 两种方式</span>
ptr <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 推荐</span>
<span class="token keyword">char</span> str<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
ptr <span class="token operator">=</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>foo<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 只支持 IPv4 的 inet_pton 函数的简单定义</span>
<span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in_val<span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_aton</span><span class="token punctuation">(</span>strptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>addrptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    errno <span class="token operator">=</span> EAFNOSUPPORT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 只支持 IPv4 的 inet_ntop 函数的简单定义</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> u_char <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> u_char <span class="token operator">*</span><span class="token punctuation">)</span>addrptr<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>family <span class="token operator">==</span> AF_INET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> temp<span class="token punctuation">[</span>INET_ADDRSTRLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">snprintf</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d.%d.%d.%d"</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token operator">>=</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            errno <span class="token operator">=</span> ENOSPC<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>strptr<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> strptr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    errno <span class="token operator">=</span> EAFNOSUPPORT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="sock-ntop-和相关函数"><a href="#sock-ntop-和相关函数" class="headerlink" title="sock_ntop 和相关函数"></a>sock_ntop 和相关函数</h2><p><code>inet_ntop</code> 的一个基本问题是：它要求调用者传递一个指向某个二进制地址的指针，而该地址通常包含在一个套接字地址结构中，这就要求调用者必须知道这个结构的格式和地址族。这就是说，为了使用这个函数，我们必须为 IPv4 编写如下代码：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> addr<span class="token punctuation">;</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>或为 IPv6 编写如下代码</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> addr6<span class="token punctuation">;</span>
<span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr6<span class="token punctuation">.</span>sin6_addr<span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>这就使得代码与协议相关了，为了解决这个问题，我们将自行编写一个名为 <code>sock_ntop</code> 的函数，它以指向某个套接字地址结构的指针为参数，查看该结构的内部，然后调用适当的函数返回该地址的表达式</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 返回：若成功则为非空指针，若出错则为 NULL</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sock_ntop</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sockaddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">char</span>         portstr<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token keyword">static</span>  <span class="token keyword">char</span>  str<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">/* Unix domain is largest */</span>
 
     <span class="token keyword">switch</span>  <span class="token punctuation">(</span>sa<span class="token operator">-></span>sa_family<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">case</span>  AF_INET<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span> sin  <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_in</span> <span class="token operator">*</span><span class="token punctuation">)</span> sa<span class="token punctuation">;</span>
 
         <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span> sin <span class="token operator">-></span>sin_addr<span class="token punctuation">,</span> str<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
             <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span> sin <span class="token operator">-></span>sin_port<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             <span class="token function">snprintf</span><span class="token punctuation">(</span>portstr<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>portstr<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">":%d"</span> <span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span> sin <span class="token operator">-></span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">strcat</span> <span class="token punctuation">(</span>str<span class="token punctuation">,</span> portstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token comment">/* end sock_ntop */</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">IPV6</span></span>
     <span class="token keyword">case</span>  AF_INET6<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_in6</span>    <span class="token operator">*</span>sin6 <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_in6</span> <span class="token operator">*</span><span class="token punctuation">)</span> sa<span class="token punctuation">;</span>
 
         str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span>  <span class="token string">'['</span> <span class="token punctuation">;</span>
         <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sin6<span class="token operator">-></span>sin6_addr<span class="token punctuation">,</span> str <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
             <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span>  <span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span>sin6<span class="token operator">-></span>sin6_port<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             <span class="token function">snprintf</span><span class="token punctuation">(</span>portstr<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>portstr<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"]:%d"</span> <span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>sin6<span class="token operator">-></span>sin6_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">strcat</span> <span class="token punctuation">(</span>str<span class="token punctuation">,</span> portstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
         <span class="token keyword">return</span>  <span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">AF_UNIX</span></span>
     <span class="token keyword">case</span>  AF_UNIX<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_un</span> <span class="token operator">*</span>unp <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_un</span> <span class="token operator">*</span><span class="token punctuation">)</span> sa<span class="token punctuation">;</span>
 
             <span class="token comment">/* OK to have no pathname bound to the socket: happens on
                every connect() unless client calls bind() first. */</span>
         <span class="token keyword">if</span>  <span class="token punctuation">(</span>unp<span class="token operator">-></span>sun_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token function">strcpy</span> <span class="token punctuation">(</span>str<span class="token punctuation">,</span>  <span class="token string">"(no pathname bound)"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
             <span class="token function">snprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"%s"</span> <span class="token punctuation">,</span> unp<span class="token operator">-></span>sun_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">HAVE_SOCKADDR_DL_STRUCT</span></span>
     <span class="token keyword">case</span>  AF_LINK<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_dl</span> <span class="token operator">*</span>sdl <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token keyword">struct</span>  <span class="token class-name">sockaddr_dl</span> <span class="token operator">*</span><span class="token punctuation">)</span> sa<span class="token punctuation">;</span>
 
         <span class="token keyword">if</span>  <span class="token punctuation">(</span>sdl<span class="token operator">-></span>sdl_nlen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token function">snprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"%*s (index %d)"</span> <span class="token punctuation">,</span>
                      sdl<span class="token operator">-></span>sdl_nlen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sdl<span class="token operator">-></span>sdl_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sdl<span class="token operator">-></span>sdl_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
             <span class="token function">snprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"AF_LINK, index=%d"</span> <span class="token punctuation">,</span> sdl<span class="token operator">-></span>sdl_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
     <span class="token keyword">default</span> <span class="token operator">:</span>
         <span class="token function">snprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>  <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">"sock_ntop: unknown AF_xxx: %d, len %d"</span> <span class="token punctuation">,</span>
                  sa<span class="token operator">-></span>sa_family<span class="token punctuation">,</span> salen<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
     <span class="token keyword">return</span>  <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="readn、writen-和-readline-函数"><a href="#readn、writen-和-readline-函数" class="headerlink" title="readn、writen 和 readline 函数"></a>readn、writen 和 readline 函数</h2><p>​    字节流套接字（例如 TCP 套接字）上的 read 和 write 函数<strong>所表现的行为不同于通常的文件 I/O</strong>。字节流套接字上调用 read 或 write 输入或输出的字节数<strong>可能比请求的数量少，然而这不是出错的状态</strong>。这个现象的原因在于内核中<strong>用于套接字的缓冲区可能已到达了极限</strong>。此时所需的是调用者再次调用 read 和 write 函数，以输入或输出剩余的字节。为预防万一，不让实现返回一个不足的字节计数值，我们总是改为调用 writen 函数来取代 write 函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 以下3个函数是每当我们读或写一个字节流套接字时总要使用的函数</span>
<span class="token class-name">ssize_t</span> <span class="token function">readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> filedes<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ssize_t</span> <span class="token function">written</span><span class="token punctuation">(</span><span class="token keyword">int</span> filedes<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ssize_t</span> <span class="token function">readline</span><span class="token punctuation">(</span><span class="token keyword">int</span> filedes<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> maxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 均返回：读或写的字节数，若出错则为-1</span>

<span class="token comment">/* 从一个描述符读n字节 */</span>
<span class="token class-name">ssize_t</span> <span class="token function">readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>vptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> nleft<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> nread<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> vptr<span class="token punctuation">;</span>
    nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> 
                nread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        nleft <span class="token operator">-=</span> nread<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> n <span class="token operator">-</span> nleft<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 往一个描述符写n字节 */</span>
<span class="token class-name">ssize_t</span> <span class="token function">writen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>vptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> nleft<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> nwritten<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> vptr<span class="token punctuation">;</span>
    nleft <span class="token operator">=</span> n<span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nleft <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>nwritten <span class="token operator">=</span> <span class="token function">wirte</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> nleft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        nleft <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
        ptr <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">/* 从一个描述符读文本行，一次1个字节 */</span>
<span class="token class-name">ssize_t</span> <span class="token function">readline</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>vptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> maxlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ssize_t</span> n<span class="token punctuation">,</span> rc<span class="token punctuation">;</span>
    <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> vptr<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> maxlen<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    again<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>rc <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token operator">*</span>ptr<span class="token operator">++</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>	<span class="token comment">/* newline is stored, like fgets() */</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> again<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 	<span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="基本-TCP-套接字编程"><a href="#基本-TCP-套接字编程" class="headerlink" title="基本 TCP 套接字编程"></a>基本 TCP 套接字编程</h2><p>服务器首先启动，稍后某个时刻客户启动，它试图连接到服务器。我们假设客户给服务器发送一个请求，服务器处理该请求，并且给客户发回一个响应。这个过程一直持续下去，直到客户关闭连接的客户端，从而给服务器发送一个 EOF （文件结束）通知位置。服务器接着也关闭连接的服务器端，然后结束运行或者等待新的客户连接</p>
<p><img src="https://s2.loli.net/2022/05/16/frVxQGFPMW6UtpI.png" alt="image-20210819195005618.png"></p>
<h2 id="socket-函数"><a href="#socket-函数" class="headerlink" title="socket 函数"></a>socket 函数</h2><p>​    为了执行网络 I/O，一个进程必须做的第一件事情就是调用 socket 函数，指定期望的通信协议类型</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为非负描述符，若出错则为-1</span>
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// TCP是一个字节流协议，仅支持 SOCK_STREAM 套接字</span>
<span class="token comment">// protocol 参数应设为某个协议类型常值，或者设为0，以选择所给点family和type组合的系统默认值</span></code></pre>

<p><img src="https://s2.loli.net/2022/05/16/15lLDNib3aKQO47.png" alt="image-20210819195122128.png"></p>
<p><img src="https://s2.loli.net/2022/05/16/8f9IXmDYHKuElkg.png" alt="image-20210819195136294.png"></p>
<p><img src="https://s2.loli.net/2022/05/16/6N8ehfnsJBolyz4.png" alt="image-20210819195244714.png"></p>
<p>socket 函数在成功时返回一个小的非负整数值，它与文件描述符类似，我们把它称为<strong>套接字描述符</strong>（socket descriptor），简称 sockfd。为了得到套接字描述符，我们只是定义了协议族和套接字类型。我们并没有指定本地协议地址或远程协议地址</p>
<h2 id="connect-函数"><a href="#connect-函数" class="headerlink" title="connect 函数"></a>connect 函数</h2><p>​    <strong>TCP客户</strong>用 connect 函数来建立与 TCP 服务器的连接</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为0，若出错则为-1</span>
<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>servaddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    sockfd 是由 socket 函数返回的套接字描述符，第二个、第三个参数分别是一个指向套接字地址结构的指针和该结构的大小。<strong>套接字地址结构必须含有服务器的 IP 地址和端口号</strong>。</p>
<p>​    客户端在调用 connect 前不必非得调用 bind 函数，因为如果需要的话，内核会确定源 IP 地址，并选择一个临时端口作为源端口，如果是 TCP 套接字，调用 connect 函数将激发 TCP 的三路握手过程，而且仅在连接建立成功或出错时才返回。<strong>若 connect 失败则该套接字不再可用，必须关闭，我们不能对这样的套接字再次调用 connect 函数</strong>（当循环调用函数 connect 为给定主机尝试各个 IP 地址直到有一个成功时，在每次 connect 失败后，都必须 close 当前的套接字描述符并重新调用 socket ）</p>
<h2 id="bind-函数"><a href="#bind-函数" class="headerlink" title="bind 函数"></a>bind 函数</h2><p>​    bind 函数把一个本地协议地址赋予一个套接字。对于 IP 协议，协议地址是 32 位的 IPv4 地址或者 128 位的 IPv6 地址与 16 位的 TCP 或 UDP 端口号的组合</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为0，若出错则为-1</span>
<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>myaddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 从 bind 函数返回的一个常见错误是 EADDRINUSE（地址已使用）</span></code></pre>

<p>第二个参数是一个指定特定于协议的地址结构的指针，第三个参数是该地址协议结构的长度。对于 TCP，调用 bind 函数可以指定一个端口号，或指定一个 IP 地址，也可以两者都指定，还可以都不指定</p>
<ul>
<li><p>服务器在启动时捆绑它们的众所周知端口。如果一个TCP客户或者服务器<strong>未曾调用 bind 捆绑一个端口</strong>，当调用 connect 或 listen 时，内核就要为相应的套接字选择一个<strong>临时端口</strong>。让内核来选择临时端口对于 TCP 客户来说是正常的，除非应用需要一个预留端口；然而对于 TCP 服务器来说却即为罕见，因为服务器是通过它们的众所周知端口被大家认识的</p>
</li>
<li><p>进程可以把一个特定的 IP 地址捆绑到它的套接字上，不过这个 IP 地址必须属于其所在主机的<strong>网络接口</strong>之一。对于 TCP 客户，这就为在该套接字上发送的 IP 数据报指派了源 IP 地址。对于 TCP 服务器，这就限定该套接字只接收哪些目的地为这个 IP 地址的客户连接。 <strong>TCP 客户通常不把 IP 地址捆绑到它的套接字上。当连接套接字时，内核将根据所用外出网络接口来选择源 IP 地址，而所用外出接口则取决于到达服务器所需的路径。</strong>如果 TCP 服务器没有把 IP 地址捆绑到它的套接字上，内核就把客户发送的 SYN 的目的 IP 地址作为服务器的源 IP 地址</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/05/16/LbIiEf3BA4VoFqT.png" alt="image-20210819202035035.png"></p>
<p>如果指定端口号位0，那么内核就在 bind 被调用时选择一个临时端口。然而如果指定 IP 地址为通配地址，那么内核将等到套接字已连接（TCP）或已在套接字上发出数据表（UDP）时，才选择一个本地 IP 地址</p>
<p>对于 IPv4来说，通配地址由常值 <code>INADDR_ANY</code> 来指定，其值一般为0。它告知内核去选择 IP 地址</p>
<p>对于 IPv6，我们就不能这么做了，因为 128 位的 IPv6地址是存放在一个结构中的，为了解决这个问题，我们改写为：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> serv<span class="token punctuation">;</span>
serv<span class="token punctuation">.</span>sin6_addr <span class="token operator">=</span> in6addr_any<span class="token punctuation">;</span></code></pre>

<p>系统预先分配 <code>in6arrd_any</code> 变量并将其初始化为常值 <code>IN6ADDR_ANY_INIT</code> 。头文件 <code>&lt;neinet/in.h&gt;</code> 中含有 <code>in6addr_any</code> 的 extern 声明</p>
<p>无论是网络字节序还是主机字节序，<code>INADDR_ANY</code> 的值（为0）都一样，因此使用 <code>htonl</code> 并非必须。不过既然头文件 <code>&lt;netinet/in.h&gt;</code> 中定义的所有 <code>INADDR_常值</code> 都是按照主机字节序定义的，我们应该对任何这些常值都使用 <code>htonl</code></p>
<p>为了得到内核所选择的这个临时端口值，必须调用函数 <code>getsockname</code> 来返回协议地址</p>
<h2 id="listen-函数"><a href="#listen-函数" class="headerlink" title="listen 函数"></a>listen 函数</h2><p>​    listen 函数仅由 <strong>TCP 服务器</strong>调用，它做两件事情：</p>
<p>（1）当 socket 函数创建一个套接字时，<strong>它被假设为一个主动套接字，也就是说，它是一个将调用 connect 发起连接的客户套接字</strong>。listen 函数把一个未连接的套接字<strong>转换成一个被动套接字</strong>，指示内核应接受指向该套接字的连接请求。根据 TCP 状态转换图，调用 listen 导致套接字从 <strong>CLOSED 状态</strong> 转换到 <strong>LISTEN 状态</strong></p>
<p>（2）本函数的第二个参数规定了内核应该为相应套接字排队的最大连接个数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为0，出错为-1</span>
<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><strong>本函数通常应该在调用 socket 和 bind 这两个函数之后，并在调用 accept 函数之前调用</strong></p>
<p>为了理解其中的 backlog 参数，我们必须认识到内核为任何一个给定的监听套接字维护两个队列：</p>
<p>（1）未完成连接队列：这些套接字处于 <strong>SYN_RCVD</strong> 状态</p>
<p>（2）已完成连接队列：这些套接字处于 <strong>ESTABLISHED</strong> 状态</p>
<p><img src="https://s2.loli.net/2022/05/16/qucopzeACxrjSik.png" alt="image-20210819204000035.png"></p>
<ul>
<li><p>当进程调用 accept 时，已完成连接队列中的队头项将返回给进程，或者如果该队列为空，那么进程将被投入睡眠，直到 TCP 在该队列中放入一项才唤醒它。源自 Berkeley 的实现给 backlog 增设了一个模糊因子：把它乘以1.5得到未处理队列的最大长度，通常指定为 5 的 backlog 值实际上允许最多有 8 项在排队</p>
</li>
<li><p>不要把 backlog 定义为 0，因为不同的实现对此有不同的理解，如果你不想让任何客户连接到你的套接字上，那就关闭该套接字</p>
</li>
</ul>
<p>那么这个 backlog 应该设为多少呢，我们通过修改 listen 函数的包裹函数就能够提供解决本问题的一个简单办法，运行环境变量 <code>LISTENQ</code> 覆写又调用者指定的值</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LISTENQ"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        backlog <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> backlog<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"listen error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="accept-函数"><a href="#accept-函数" class="headerlink" title="accept 函数"></a>accept 函数</h2><p>​    accept 函数由 <strong>TCP 服务器</strong>调用，用于从已完成连接队列头返回下一个已完成连接。<strong>如果已完成连接队列为空，那么进程被投入睡眠（假定套接字为默认的阻塞方式）</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为非负描述符，若出错则为-1</span>
<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>cliaddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>参数 cliaddr 和 addrlen 用来返回已连接的对端进程（客户）的协议地址。addrlen是值-结果参数：调用前，我们将由 *addrlen 所引用的整数值置为由 cliaddr 所指的套接字地址结构的长度，返回时，该整数值即为由内核存放在该套接字地址结构内的确切字节数</p>
<p>如果 accept 成功，那么其<strong>返回值是由内核自动生成的一个全新描述符，代表所返回客户的 TCP 连接</strong>。在讨论 accept 函数时，我们称它的第一个参数为<strong>监听套接字（listening socket）描述符</strong>（由 socket 创建，随后用作 bind 和 listen 的第一个参数的描述符），称它的返回值为<strong>已连接套接字（connected socket）描述符</strong>。一个服务器通常仅仅创建一个监听套接字，它在该服务器的生命期内一直存在。内核为每个服务器进程接受的客户连接一个已连接套接字。<strong>当服务器完成对某个给定客户的服务时，相应的套接字就被关闭</strong></p>
<p>本函数最多返回三个值：一个既可能是新套接字描述符也可能是出错指示的整数、客户进程的协议地址以及该地址的大小。<strong>如果我们对返回客户协议地址不感兴趣，那么可以把 cliaddr 和 addrlen 均置为空指针</strong></p>
<h2 id="close-函数"><a href="#close-函数" class="headerlink" title="close 函数"></a>close 函数</h2><p>​    close 函数用来关闭套接字，并终止 TCP 连接</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// 返回：若成功则为0，若出错则为-1</span>
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>close 一个 TCP 套接字的默认行为是<strong>把该套接字标记成已关闭，然后立即返回到调用进程</strong>。该套接字描述符不能再由进程使用，也就是说它不能再作为 read 或 write 的第一个参数。然而 TCP 将尝试发送已排队等待发送到对端的任何数据，发送完毕后发生的是正常的 TCP 连接终止序列</p>
<h2 id="fork-和-exec-函数"><a href="#fork-和-exec-函数" class="headerlink" title="fork 和 exec 函数"></a>fork 和 exec 函数</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// 返回：在子进程中为0，在父进程中为子进程ID，若出错则为-1</span>
<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>理解 fork 最困难之处在于调用它一次，它却返回两次。它在调用进程（称为父进程）中返回一次，返回值是新派生进程（称为子线程）的进程ID号，在子进程又返回一次，返回值为0。因此，<strong>返回值本身告知当前进程是子进程还是父进程</strong></p>
<p>fork在子进程返回 0 而不是父进程的进程 ID 的原因在于：<strong>任何子进程只有一个父进程</strong>，而且子进程总是可以通过调用 <code>getppid</code> 取得父进程的进程 ID。相反，<strong>父进程可以有许多子进程，而且无法获取各个子进程的进程 ID</strong>。如果父进程想要跟踪所有子进程的进程 ID，那么它必须记录每次调用 fork 的返回值</p>
<p><strong>父进程中调用 fork 之前打开的所有描述符在 fork 返回之后由子进程分享。</strong>网络服务器利用了这个特性：父进程调用accept 之后调用 fork。所接受的已连接套接字随后就在父进程与子进程之间共享。<strong>通常情况下，子进程接着读写这个已连接套接字，父进程则关闭这个已连接套接字。</strong></p>
<p>fork有两个典型用法：</p>
<p>（1）一个进程创建一个自身的副本，这样每个副本都可以在另一个副本执行其他任务的同时处理各自的某个操作。</p>
<p>（2）一个进程想要执行另一个程序。既然创建新进程的唯一办法是调用 fork，该进程于是首先调用 fork 创建一个自身的副本，然后其中一个副本（通常为子进程）调用 exec 把自身替换成新的程序。（exec 把当前进程映像替换成新的程序文件，而且该新程序通常从main函数开始执行。进程 ID 并不改变。我们称调用 exec 的进程为<strong>调用进程（calling process）</strong>，称新执行的程序为<strong>新程序（new program）</strong>）</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (char*) 0 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// envp用来存放环境变量的地址数组</span>
<span class="token keyword">int</span> <span class="token function">execle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (cahr *) 0, char *const envp[] */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execvpe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (char *) 0 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>这些函数只在出错时才返回到调用者。否则，控制将被传递给新程序的起始点，通常就是 main 函数。</p>
<p>一般来说，只有 <code>execve</code> 是内核中的系统调用，其它 5 个都是调用 <code>execve</code> 的库函数</p>
<p><img src="https://s2.loli.net/2022/05/16/UiXwRnGNmoISa5g.png" alt="image-20210819214735112.png"></p>
<h2 id="并发服务器"><a href="#并发服务器" class="headerlink" title="并发服务器"></a>并发服务器</h2><p>当服务一个客户请求可能花费较长时间时，我们并不希望整个服务器被单个客户长期占用，而是希望同时服务多个客户。Unix 中编写并发服务器程序的最简单办法就是 fork 一个子进程来服务每个客户。大多数 TCP 服务器是并发的，它们<strong>为每个待处理的客户连接调用 fork 派生一个子进程</strong>。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
<span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span>
listenfd <span class="token operator">=</span> <span class="token function">Socket</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Linsten</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    connfd <span class="token operator">=</span> <span class="token function">Accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">Close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* child closes listening socket */</span>
        <span class="token function">doit</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* process the request */</span>
        <span class="token function">Close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">/* done with this client */</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* child terminates */</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">Close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">/* parent closes connected socket */</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
	解释：在父进程调用pid = Fork()，返回子进程的ID，子进程创建之后从main函数处重新执行，当子进程调用 pid = Fork()时返回0，这时进入循环，执行
		 doit(connfd)操作，执行完后退出即可；父进程由于将任务转交给了子进程，故可以关闭已连接套接字了
*/</span></code></pre>

<p>当一个连接建立时， accept 返回，服务器接着调用 fork，然后由子进程服务客户（通过已连接套接字 connfd），父进程则等待另一个连接（通过监听套接字listenfd）。<strong>既然新的客户由子进程提供服务，父进程就关闭已连接套接字</strong>。</p>
<p><img src="https://s2.loli.net/2022/05/16/qcCIdSejBTyFD1x.png" alt="image-20210819220414849.png"></p>
<p><img src="https://s2.loli.net/2022/05/16/FsbJGqNtz2IBYux.png" alt="image-20210819220425771.png"></p>
<p><img src="https://s2.loli.net/2022/05/16/LU6D31opMBmCKYj.png" alt="image-20210819220436367.png"></p>
<p><img src="https://s2.loli.net/2022/05/16/ZQVUvFeb9BJiT7f.png" alt="image-20210819220448880.png"></p>
<h2 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h2><p>一个子进程在调用 return 或 exit(0) 结束自己的生命的时候，其实它并没有真正被销毁，而是留下一个<code>僵死进程</code> 。我们显然不愿意留存僵死进程。它们占用内核中的空间，最终可能导致我们耗尽进程资源。在 <code>ps</code> 命令输出的 CMD 栏以 <code>&lt;defunct&gt;</code> 指明僵死进程，无论何时我们 fork 子进程都得 wait 它们，以防它们变成僵死进程。为此我们建立一个俘获 <code>SIGCHLD</code> 信号的信号处理函数，<strong>这必须在 fork 第一个子进程之前完成，且只做一次</strong>。</p>
<p>值得关注的是，在某些系统下，如果一个进程把 <code>SIGCHLD</code> 的处置设定为 <code>SIG_IGN</code> ，它的子进程就不会变为僵死进程，即在主函数中添加：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 忽略子进程退出的信号，避免产生僵死进程</span></code></pre>

<p>但是这种做法不具有可移植，处理僵死进程的可移植方法就是捕获 <code>SIGCHLD</code>，并调用 <code>wait</code> 或 <code>waitpid</code> </p>
<p><strong>处理被中断的系统调用</strong></p>
<p>​    我们用术语慢系统调用描述 <code>accept</code> 函数，该术语也适用于那些可能<strong>永远阻塞的系统调用</strong>。永远阻塞的系统调用是指调用有可能永远无法返回，多数网络支持函数都属于这一类。</p>
<p>​    适用于慢系统调用的基本规则是：当阻塞于某个慢系统调用的一个进程捕获某个信号且相应信号处理函数返回时，该系统调用可能返回一个 <code>EINTR</code> 错误。为了便于移植，我们必须对慢系统调用返回 <code>EINTR</code> 有所准备</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 不过有一个函数我们不能重启 : connect</span>
<span class="token comment">// 如果该函数返回 EINTR，我们就不能再次调用它，否则将立即返回一个错误</span></code></pre>



<h2 id="wait-和-waitpid-函数"><a href="#wait-和-waitpid-函数" class="headerlink" title="wait 和 waitpid 函数"></a>wait 和 waitpid 函数</h2><p>处理已终止的子进程</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>

<span class="token comment">// 均返回：若成功则为进程ID，若出错则为0或-1</span>
<span class="token class-name">pid_t</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>statloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">pid_t</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>statloc<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>函数 wait 和 waitpid 均返回两个值：已终止子进程的进程ID号，以及通过 <code>statloc</code> 指针返回的子进程终止状态（一个整数）。我们可以调用三个宏来检查终止状态，并辨别子进程是<strong>正常终止</strong>、<strong>由某个信号杀死</strong>还是仅仅<strong>由作业控制停止</strong>。</p>
<p>如果调用 wait 的进程没有已终止的子进程，不过有一个或多个子进程仍在执行，那么 wait 将阻塞到现有子进程第一个终止为止</p>
<p>waitpid 函数就等待哪个进程以及是否阻塞给了我们更多的控制。首先，<code>pid</code> 参数允许我们制定想等待的进程 ID，<strong>值 -1 表示等待第一个终止的子进程</strong>。其次，<code>options</code> 参数允许我们指定附加选项。最常用的选项是 <code>WNOHANG</code>，它告知内核在没有已终止子进程时不要阻塞。</p>
<p>建立一个信号处理函数并在其中调用 wait 并不足以防止出现僵死进程。正确的解决办法是调用 waitpid 而不是 wait：<strong>我们在一个循环内调用 waitpid，以获取所有已终止子进程的状态，指定 <code>WNOHANG</code> 选项</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// wait</span>
<span class="token keyword">void</span> <span class="token function">sig_chld</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> stat<span class="token punctuation">;</span>
    
    pid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// waitpid (正确)</span>
<span class="token keyword">void</span> <span class="token function">sig_chld</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> stat<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="并发服务器代码模板"><a href="#并发服务器代码模板" class="headerlink" title="并发服务器代码模板"></a>并发服务器代码模板</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sig_chld</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> childpid<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> chilen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> cliaddr<span class="token punctuation">,</span> servaddr<span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">Socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>SERV_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> LISTENQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> sig_chld<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* must call waitpid */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        clilen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cliaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cliaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clilen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token function">prrer</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">Fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">Close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doit</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* process the request */</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">Close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><pre class="language-c" data-language="c"><code class="language-c"> <span class="token number">1</span> #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">2</span> #include <span class="token operator">&lt;</span>netinet<span class="token operator">/</span>in<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">3</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">4</span> #include <span class="token operator">&lt;</span>arpa<span class="token operator">/</span>inet<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">5</span> #include <span class="token operator">&lt;</span>unistd<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">6</span> #include <span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">7</span> #include <span class="token operator">&lt;</span>strings<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">8</span> #include <span class="token operator">&lt;</span>signal<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">9</span> #include <span class="token operator">&lt;</span>sys<span class="token operator">/</span>wait<span class="token punctuation">.</span>h<span class="token operator">></span>
<span class="token number">10</span> #include <span class="token operator">&lt;</span>errno<span class="token punctuation">.</span>h<span class="token operator">></span>
<span class="token number">11</span> 
<span class="token number">12</span> #define MAXLEN <span class="token number">512</span>
<span class="token number">13</span> 
<span class="token number">14</span> <span class="token keyword">void</span> <span class="token function">sig_chld</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">15</span>     <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
<span class="token number">16</span>     <span class="token keyword">int</span> stat<span class="token punctuation">;</span>
<span class="token number">17</span> 
<span class="token number">18</span>     <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">19</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"child %d terminated\n "</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span> 
<span class="token number">21</span>     <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token punctuation">&#125;</span>
<span class="token number">23</span> 
<span class="token number">24</span>
<span class="token number">25</span> <span class="token keyword">void</span> <span class="token function">doit</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">26</span>     <span class="token class-name">ssize_t</span> n<span class="token punctuation">;</span>
<span class="token number">27</span>     <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">28</span> 
<span class="token number">29</span>     <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">30</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"读入了%ld个字节的数据\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">31</span>          buf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
<span class="token number">32</span>          <span class="token function">puts</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">33</span>     <span class="token punctuation">&#125;</span>
<span class="token number">34</span>     <span class="token class-name">pid_t</span> parentpid <span class="token operator">=</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">35</span>     <span class="token class-name">pid_t</span> selfpid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">36</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我是子进程pid = %d，我的任务完成了，父进程pid = %d\n"</span><span class="token punctuation">,</span> selfpid<span class="token punctuation">,</span>  parentpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">37</span> <span class="token punctuation">&#125;</span>
<span class="token number">38</span>
<span class="token number">39</span> <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">40</span>     <span class="token comment">// 一种解决僵死进程的办法，虽然方便，但是不推荐</span>
<span class="token number">41</span>     <span class="token comment">// signal(SIGCHLD, SIG_IGN);</span>
<span class="token number">42</span>     
<span class="token number">43</span>     <span class="token class-name">pid_t</span> childpid<span class="token punctuation">;</span>
<span class="token number">44</span>     <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span>
<span class="token number">45</span>     sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">46</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">47</span>         <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sockfd error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">48</span>         <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">49</span>     <span class="token punctuation">&#125;</span>   
<span class="token number">50</span>     
<span class="token number">51</span>     <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serv<span class="token punctuation">;</span>
<span class="token number">52</span>     <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">53</span>     
<span class="token number">54</span>     serv<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
<span class="token number">55</span>     serv<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">56</span>     
<span class="token number">57</span>     <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"172.19.47.4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">58</span>     <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">59</span>     <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">60</span>     <span class="token comment">// 解决僵死进程</span>
<span class="token number">61</span>     <span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> sig_chld<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">62</span>     <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">63</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">64</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
<span class="token number">65</span>                 <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">66</span>             <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token number">67</span>                 <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">68</span>                 <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">69</span>             <span class="token punctuation">&#125;</span>   
<span class="token number">70</span>         <span class="token punctuation">&#125;</span>   
<span class="token number">71</span>         
<span class="token number">72</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">73</span>             <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">74</span>             <span class="token function">doit</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">75</span>             <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">76</span>             <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">77</span>         <span class="token punctuation">&#125;</span>
<span class="token number">78</span>         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"创建了一个子进程, id = %d\n"</span><span class="token punctuation">,</span> childpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">79</span>         <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">80</span>     <span class="token punctuation">&#125;</span>
<span class="token number">81</span>     <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">82</span> 
<span class="token number">83</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">84</span> <span class="token punctuation">&#125;</span></code></pre>



<h2 id="getsockname-和-getpeername-函数"><a href="#getsockname-和-getpeername-函数" class="headerlink" title="getsockname 和 getpeername 函数"></a>getsockname 和 getpeername 函数</h2><p>这两个函数或者返回某个套接字关联的本地协议地址（getsockname），或者返回与某个套接字关联的外地协议地址（getpeername）</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">getsockname</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>localaddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">getpeername</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>peeraddr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>注意，这两个函数的最后一个参数都是值-结果参数。这就是说，这两个函数都得装填由 localaddr 或 peeraddr 指针所指的套接字地址结构</p>
<p>需要这两个函数的理由如下所述：</p>
<ul>
<li>在一个没有调用 bind 的 TCP 客户上， connect 成功返回后，getsockname 用于返回由内核赋予该连接的本地 IP 地址和端口号</li>
<li>在以端口号0调用 bind（告知内核去选择本地端口号）后，getsockname 用于返回由内核赋予的本地端口号</li>
<li>getsockname 可以用于获取某个套接字的地址族</li>
<li>在一个以通配 IP 地址调用 bind 的 TCP 服务器上，与某个客户的连接一旦建立（accept成功返回），getsockname就可以用于返回由内核赋予该连接的本地 IP 地址。</li>
<li>当一个服务器是由调用过 accept 的某个进程通过调用 exec 执行程序时，它能够获取客户身份的唯一途径便是调用 getpeername</li>
</ul>
<p>例子：<strong>获取套接字的地址族</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sockfd_to_family</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> ss<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> len<span class="token punctuation">;</span>
    
    len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getsockname</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ss<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ss<span class="token punctuation">.</span>ss_family<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="recv-和-send函数"><a href="#recv-和-send函数" class="headerlink" title="recv 和 send函数"></a>recv 和 send函数</h2><p>这两个函数类似标准的 <code>read</code> 和 <code>write</code> 函数，不过需要一个额外的参数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token comment">// 返回：若成功则为读入或写出的字节数，若出错则为-1</span>
<span class="token comment">// 注意这两个函数只能用于socket通信</span>
<span class="token class-name">ssize_t</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>recv</code> 和 <code>send</code>的前三个参数等同于 <code>read</code> 和 <code>write</code> 的3个参数。<code>flags</code> 参数的值或为0，或为如下列出的一个或多个常值的逻辑或</p>
<p><img src="https://s2.loli.net/2022/05/16/AT8HmeJ3Bcirx7h.png" alt="image-20210821185525533.png"></p>
<p>flags参数在设计上存在一个基本问题：它是按值传递的，而不是一个值-结果参数。因此它只能用于从进程向内核传递标志。内核无法向进程传回标志。</p>
<h2 id="gethostbyname-和-gethostbyaddr-函数"><a href="#gethostbyname-和-gethostbyaddr-函数" class="headerlink" title="gethostbyname 和 gethostbyaddr 函数"></a>gethostbyname 和 gethostbyaddr 函数</h2><p>gethostbyname函数根据主机名获取主机的完整信息，gethostbyaddr函数根据IP地址获取主机的完整信息。gethostbyname函数通常先在本地的 <code>/etc/hosts</code> 配置文件中查找主机，如果没有找到，再去访问 DNS 服务器</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> <span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>name</code>参数指定目标主机的主机名，<code>addr</code> 参数指定目标主机的 IP 地址，<code>len</code> 参数指定 addr 所指的 IP 地址，<code>type</code> 参数指定 addr 所指 IP 地址的类型，其合法取值包括 AF_INET 和 AF_INET6</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// hostent 结构体的定义如下</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">char</span><span class="token operator">*</span> h_name<span class="token punctuation">;</span>		<span class="token comment">/* 主机名 */</span>  
  	<span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> h_aliases<span class="token punctuation">;</span>	<span class="token comment">/* 主机别名列表, 可能有多个 */</span>
    <span class="token keyword">int</span> h_addrtype<span class="token punctuation">;</span>		<span class="token comment">/* 地址类型（地址族）*/</span>
    <span class="token keyword">int</span> h_length<span class="token punctuation">;</span>		<span class="token comment">/* 地址长度 */</span>
    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> h_addr_list<span class="token punctuation">;</span>	<span class="token comment">/* 按网络字节序列出的主机 IP 地址列表 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>



<h2 id="getservbyname-和-getservbyport"><a href="#getservbyname-和-getservbyport" class="headerlink" title="getservbyname 和 getservbyport"></a>getservbyname 和 getservbyport</h2><p>getservbyname 函数根据名称获取某个服务的完整信息， getservbyport 函数根据端口号获取某个服务的完整信息。它们实际上都是通过读取 /etc/services 文件来获取服务的信息的。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">struct</span> <span class="token class-name">servent</span><span class="token operator">*</span> <span class="token function">getservbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">servent</span><span class="token operator">*</span> <span class="token function">getservbyport</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>name</code> 参数指定目标服务的名字，<code>port</code> 参数指定目标服务对应的端口号。<code>proto</code> 参数指定服务类型，给它传递 “tcp” 表示获取流服务，给它传递 “udp” 表示获取数据报服务，给它传递 NULL 则表示获取所有类型的服务</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 结构体 servent 的定义如下:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>

<span class="token keyword">struct</span> <span class="token class-name">servent</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> s_name<span class="token punctuation">;</span>		<span class="token comment">/* 服务名称 */</span>
    <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> s_aliases<span class="token punctuation">;</span>	<span class="token comment">/* 服务的别名列表, 可能有多个 */</span>
    <span class="token keyword">int</span> s_port<span class="token punctuation">;</span>			<span class="token comment">/* 端口号 */</span>
    <span class="token keyword">char</span><span class="token operator">*</span> s_proto<span class="token punctuation">;</span>		<span class="token comment">/* 服务类型，通常的tcp 或者 udp */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>需要指出的是，上面讨论的4个函数都是不可重入的，即非线程安全的。不过 <code>netdb.h</code> 头文件给出了它们的可重入版本。正如 Linux 下所有其他函数的可重入版本的命名规则那样，这些函数的函数名是在原函数名尾部加上 _r (re_entrant)</p>
<h2 id="高级-I-O-函数"><a href="#高级-I-O-函数" class="headerlink" title="高级 I/O 函数"></a>高级 I/O 函数</h2><h3 id="pipe-函数"><a href="#pipe-函数" class="headerlink" title="pipe 函数"></a>pipe 函数</h3><p>pipe 函数可用于创建一个管道，以实现进程间通信</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    pipe 函数的参数是一个包含两个 int 型整数的数组指针。该函数成功时返回 0，并将一对打开的文件描述符值填入其参数指向的数组。如果失败则返回 -1 并设置 errno</p>
<p>​    通过 pipe 函数创建的这两个文件描述符 <code>fd[0]</code> 和 <code>fd[1]</code> 分别构成管道的两端，往 <code>fd[1]</code> 写入的数据可以从 <code>fd[0]</code> 读出。并且，<code>fd[0]</code> 只能用于从管道中读出数据，<code>fd[1]</code> 则只能用于往管道写入数据，而不能反过来使用。如果要实现双向的数据传输，就应该使用两个管道。默认情况下，这一对文件描述符都是<strong>阻塞的</strong>。</p>
<p>​    管道内部传输的数据是<strong>字节流</strong>，本身拥有一个容量限制，自 Linux 2.6.11 内核起，管道容量的大小默认是 65536 字节。我们可以使用 <code>fcntl</code> 函数来修改管道容量。</p>
<h3 id="socketpair-函数"><a href="#socketpair-函数" class="headerlink" title="socketpair 函数"></a>socketpair 函数</h3><p>能够方便地创建<strong>双向管道</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>

<span class="token keyword">int</span> <span class="token function">socketpair</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>​    socketpair 前三个参数的含义与 socket 系统调用的三个参数完全相同，但 domain 只能使用 UNIX 本地域协议族 <code>AF_UNIX</code> ，因为我们仅能在本地使用这个双向管道。最后一个参数和 pipe 系统调用的参数一样，只不过创建的这对文件描述符都是<strong>既可读又可写</strong>的。成功时返回0，失败时返回-1并设置errno</p>
<h3 id="dup-函数和-dup2-函数"><a href="#dup-函数和-dup2-函数" class="headerlink" title="dup 函数和 dup2 函数"></a>dup 函数和 dup2 函数</h3><p>有时我们希望把标准输出重定向到一个文件，或者把标准输出重定向到一个网络连接（比如 CGI 编程）。可以通过以下两个函数来实现：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> file_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> file_descriptor_one<span class="token punctuation">,</span> <span class="token keyword">int</span> file_descriptor_two<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>dup 函数创建一个新的文件描述符，该新文件描述符和原有文件描述符 file_descriptor <strong>指向相同的文件、管道或者网络连接</strong>。并且 dup 返回的文件描述符总是取系统当前可用的<strong>最小整数值</strong>。dup2 和 dup 类似，不过它将返回第一个不小于 file_descriptor_two 的整数值。失败时返回-1并设置errno</p>
<p><strong>注意</strong>：通过 dup 和 dup2 创建的文件描述符并<strong>不继承原文件描述符的属性</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// CGI 服务器原理 ： 将标准输出重定向到网络连接</span>

<span class="token comment">// 关闭标准输出文件描述符</span>
<span class="token function">close</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 复制socket文件描述符</span>
<span class="token function">dup</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 因为dup的特点，返回值为之前关闭的标准输出文件描述符的值(1)</span>
<span class="token comment">// 这样一来，服务器输出到标准输出的内容就会直接发送到与客户连接对应的socket上</span></code></pre>



<h3 id="readv-函数和-writev-函数"><a href="#readv-函数和-writev-函数" class="headerlink" title="readv 函数和 writev 函数"></a>readv 函数和 writev 函数</h3><p>readv 函数将数据从文件描述符读到分散的内存块中，即 <code>分散读</code> ；writev 函数则将多块分散的内存数据一并写入文件描述符中，即 <code>集中写</code> 。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span>

<span class="token class-name">ssize_t</span> <span class="token function">readv</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span><span class="token operator">*</span> vector<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">writev</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span><span class="token operator">*</span> vector<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>fd</code> 参数是被操作的目标文件描述符。<code>vector</code> 参数的类型是 <code>iovec</code> 结构体数组。该结构描述一块内存区。<code>count</code> 参数的内存块数。成功时返回读出/写入 <code>fd</code> 的字节数，失败则返回-1并设置errno</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// iovec 结构体的定义</span>
<span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>iov_base<span class="token punctuation">;</span>		<span class="token comment">/* 内存起始地址 */</span>
    <span class="token class-name">size_t</span> iov_len<span class="token punctuation">;</span>		<span class="token comment">/* 这块内存的长度 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>当 Web 服务器解析完一个 HTTP 请求之后，如果目标文档存在且客户具有读取该文档的权限，那么它就需要发送一个 HTTP 应答来传输该文档。这个 HTTP 应答包含 1 个状态行、多个头部字段、1 个空行和文档内容。其中，前三部分的内容可能被 Web 服务器放置在一块内存中，而文档的内容则通常被读入到另一块单独的内存中。我们并不需要把这两部分内容拼接到一起再发送，而是可以使用 writev 函数将它们同时写出</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// Web 服务器上的集中写</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> status_line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"200 OK"</span><span class="token punctuation">,</span> <span class="token string">"500 Internal server error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please input three argument\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> file_name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>sock <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span> header_buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>header_buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> file_buf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">stat</span> file_stat<span class="token punctuation">;</span>
        bool valid <span class="token operator">=</span> true<span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_stat<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            valid <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>file_stat<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                valid <span class="token operator">=</span> false<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>file_stat<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IROTH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                file_buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span>file_stat<span class="token punctuation">.</span>st_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> file_buf<span class="token punctuation">,</span> file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    valid <span class="token operator">=</span> false<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> valid <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ret <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>header_buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%s %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status_line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            len <span class="token operator">+=</span> ret<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>header_buf <span class="token operator">+</span> len<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> len<span class="token punctuation">,</span>
                            <span class="token string">"Content-Length: %ld\r\n"</span><span class="token punctuation">,</span> file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            len <span class="token operator">+=</span> ret<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>header_buf <span class="token operator">+</span> len<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> len<span class="token punctuation">,</span>
                            <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> header_buf<span class="token punctuation">;</span>
            iv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>header_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> file_buf<span class="token punctuation">;</span>
            iv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            ret <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>header_buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%s %s\r\n"</span><span class="token punctuation">,</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span> status_line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            len <span class="token operator">+=</span> ret<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>header_buf <span class="token operator">+</span> len<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> len<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">send</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> header_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>header_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>file_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="sendfile-函数"><a href="#sendfile-函数" class="headerlink" title="sendfile 函数"></a>sendfile 函数</h3><p>sendfile 函数在两个文件描述符之间<strong>直接</strong>传递数据（完全在内核中操作），从而避免了内核缓冲区和用户缓冲区之间的数据拷贝，效率很高，这被称为<strong>零拷贝</strong>。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h></span></span>

<span class="token class-name">ssize_t</span> <span class="token function">sendfile</span><span class="token punctuation">(</span><span class="token keyword">int</span> out_fd<span class="token punctuation">,</span> <span class="token keyword">int</span> in_fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span><span class="token operator">*</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>in_fd</code> 参数是待读出内容的文件描述符，<code>out_fd</code> 参数的待写入内容的文件描述符，<code>offset</code> 参数指定从读入文件流的哪个位置开始读，如果为空，则使用读入文件流默认的起始位置。<code>count</code> 参数指定在文件描述符之间传递的字节数。成功时返回传递的字节数，失败则返回 -1 并设置errno</p>
<p><code>in_fd</code> 必须是一个支持类似 <code>mmap</code> 函数的文件描述符，即它<strong>必须指向真实的文件</strong>，不能是 socket 和管道；而 <code>out_fd</code> 则<strong>必须是一个 socket（也可以是标准输出）</strong>。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 利用 sendfile 函数将服务器上的一个文件传动给客户端</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> file_name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> filefd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>filefd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> stat_buf<span class="token punctuation">;</span>
    <span class="token function">fstat</span><span class="token punctuation">(</span>filefd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">assert</span><span class="token punctuation">(</span>sock <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>sock <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sendfile</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> filefd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> stat_buf<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>相比上一个例子，使用 sendfile 没有目标文件分配任何用户空间的缓存，也没有执行读取文件的操作（只打开了文件），但同样实现了文件的发送，<strong>效率要高得多</strong>。</p>
<h3 id="mmap-函数和-munmap-函数"><a href="#mmap-函数和-munmap-函数" class="headerlink" title="mmap 函数和 munmap 函数"></a>mmap 函数和 munmap 函数</h3><p>mmap 函数用于申请一段内存空间。我们可以将这段内存空间作为进程间通信的<strong>共享内存</strong>，也可以将文件之间映射到其中。 munmap 函数则释放由 mmap 创建的这段内存空间</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>start<span class="token punctuation">,</span> <span class="token class-name">size_t</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>start</code> 参数允许用户使用某个特定的地址作为这段内存的起始地址。如果它别设置成 NULL，则系统自动分配一个地址。<code>length</code> 参数指定内存段的大小。<code>prot</code> 参数用来设置内存段的访问权限：</p>
<ul>
<li><strong>PROT_READ</strong>，内存段可读</li>
<li><strong>PROT_WRITE</strong>，内存段可写</li>
<li><strong>PROT_EXEC</strong>，内存段可执行</li>
<li><strong>PROT_NONE</strong>，内存段不能被访问</li>
</ul>
<p><code>flags</code> 参数控制内存段内容被修改后程序的行为。<code>fd</code> 参数是被映射文件对应的文件描述符。它一般通过 open 系统调用获得。 <code>offset</code> 参数设置从文件的何处开始映射（对于不需要读入整个文件的情况）</p>
<p>成功时返回指向目标内存区域的指针，失败则返回 MAP_FAILED（(void*)-1）并设置 errno。munmap 函数成功时返回0，失败时返回-1并设置 errno</p>
<h3 id="splice-函数"><a href="#splice-函数" class="headerlink" title="splice 函数"></a>splice 函数</h3><p>splice 函数用于在<strong>两个文件描述符之间移动数据</strong>，也是零拷贝操作</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token class-name">ssize_t</span> <span class="token function">splice</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd_in<span class="token punctuation">,</span> loff<span class="token operator">*</span> off_in<span class="token punctuation">,</span> <span class="token keyword">int</span> fd_out<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> off_out<span class="token punctuation">,</span>
               <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>fd_in</code> 参数是待输入数据的文件描述符。如果 <code>fd_in</code> 是一个管道文件描述符，那么 <code>off_in</code> 参数必须被设置为 NULL。如果 <code>fd_in</code> 不是一个管道文件描述符，那么 <code>off_in</code> 表示从输入数据流的何处开始读取数据。此时，若 <code>off_in</code> 被设置为 NULL，则表示从输入数据流的当前偏移位置读入。<code>fd_out/off_out</code> 参数的含义与 <code>fd_in/off_in</code> 相同，不过用于输出数据流。<br><code>len</code> 参数指定移动数据的长度。<code>flags</code> 参数则控制数据如何移动：</p>
<ul>
<li><strong>SPLICE_F_MOVE</strong> : 如果合适的话，按整页内存移动数据，这只是给内核的一个提示。不过，因为它的实现存在 BUG，所以自内核 2.6.21 后，它实际上没有任何效果</li>
<li><strong>SPLICE_F_NOBLOCK</strong> : 非阻塞的 splice 操作，但实际效果还会受文件描述符本身的阻塞状态的影响</li>
<li><strong>SPLICE_F_MORE</strong> : 给内核的一个提示，后序的 splice 调用将读取更多数据</li>
<li><strong>SPLICE_F_GIFT</strong> : 对 splice 没有效果</li>
</ul>
<p>使用 splice 函数时， <code>fd_in</code> 和 <code>fd_out</code> 必须至少有一个是管道文件描述符。splice 函数调用成功时返回移动字节数的数量。失败时返回-1并设置 errno</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 使用 splice 函数实现一个零拷贝的回射服务器：它将客户端发送的数据原样返回给客户端</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span> </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sendfile.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">splice</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_MORE <span class="token operator">|</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">splice</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> connfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_MORE <span class="token operator">|</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="tee-函数"><a href="#tee-函数" class="headerlink" title="tee 函数"></a>tee 函数</h3><p>tee 函数在<strong>两个管道文件描述符之间复制数据</strong>，也是零拷贝操作。它不消耗数据，因此源文件描述符上的数据仍然可以用于后续的读操作</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token class-name">ssize_t</span> <span class="token function">tee</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd_in<span class="token punctuation">,</span> <span class="token keyword">int</span> fd_out<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>该函数的参数的含义与 splice 相同（但 <code>fd_in</code> 和 <code>fd_out</code> 必须都是管道文件描述符）。tee 函数成功时返回在两个文件描述符之间复制的数据量（字节数）。返回0表示没有复制任何数据。失败时返回-1并设置 errno</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 同时输出数据到终端和文件的程序</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token keyword">int</span> filefd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>filefd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">int</span> pipefd_stdout<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd_stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> pipefd_file<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>pipefd_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">splice</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pipefd_stdout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_MORE <span class="token operator">|</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将管道 pipefd_stdout 的输出复制到管道 pipefd_file 的输入端</span>
    ret <span class="token operator">=</span> <span class="token function">tee</span><span class="token punctuation">(</span>pipefd_stdout<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pipefd_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">splice</span><span class="token punctuation">(</span>pipefd_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filefd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_MORE <span class="token operator">|</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ret <span class="token operator">=</span> <span class="token function">splice</span><span class="token punctuation">(</span>pipefd_stdout<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> SPLICE_F_MORE <span class="token operator">|</span> SPLICE_F_MOVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>filefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd_stdout<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd_stdout<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="fcntl-函数"><a href="#fcntl-函数" class="headerlink" title="fcntl 函数"></a>fcntl 函数</h3><p>fcntl 函数（file control）。提供了对文件描述符的各种控制操作。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>fd</code> 参数是被操作的文件描述符，<code>cmd</code> 参数指定执行何种类型的操作。根据操作类型的不同，该函数可能还需要第三个可选参数 <code>arg</code> 。在网络编程中，fcntl 函数通常用来将一个文件描述符设置为非阻塞的。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 获取文件描述符旧的状态标志 */</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>	<span class="token comment">/* 设置为非阻塞标志 */</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>	<span class="token comment">/* 返回文件描述符旧的状态标志，以便日后恢复该状态标志 */</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="I-O复用"><a href="#I-O复用" class="headerlink" title="I/O复用"></a>I/O复用</h2><p>I/O复用使得程序能同时监听多个文件描述符，这对提高程序的性能至关重要。使用场景：</p>
<ul>
<li>客户端程序需要同时处理多个 socket</li>
<li>客户端程序要同时处理用户输入和网络连接</li>
<li>TCP 服务器要同时处理监听 socket 和连接 socket</li>
<li>服务器要同时处理 TCP 请求和 UDP 请求</li>
<li>服务器要同时监听多个端口，或者处理多种服务</li>
</ul>
<p>I/O 复用虽然能同时监听多个文件描述符，但它本身是阻塞的。如果要实现并发，只能使用多进程或多线程等编程手段。</p>
<h3 id="select-系统调用"><a href="#select-系统调用" class="headerlink" title="select 系统调用"></a>select 系统调用</h3><p>select 系统调用的用途是：在<strong>一段指定时间内</strong>，<strong>监听</strong>用户感兴趣的文件描述符上的<strong>可读</strong>、<strong>可写</strong>和<strong>异常</strong>等事件。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> readfds<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> writefds<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span><span class="token operator">*</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// fd_set 结构体定义如下</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    __fd_mask fds_bits<span class="token punctuation">[</span>__FD_SETSIZE <span class="token operator">/</span> __NFDBITS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> fd_set<span class="token punctuation">;</span>
<span class="token comment">// fd_set 结构体仅包含一个整型数组，该数据的每个元素的每一位标记一个文件描述符</span>
<span class="token comment">// 能容纳的文件描述符数量由 FD_SETSIZE 指定，这就限制了 select 能同时处理的文件描述符的数量</span>

<span class="token comment">/* 由于位操作过于繁琐, 我们应该使用下面的一系列宏来访问 fd_set 结构体中的位 */</span>

<span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set<span class="token operator">*</span> fdset<span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">/* 清除 fdset 的所有位 */</span>
<span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 设置 fdset 的位fd */</span>
<span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> fdset<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 清除 fdset 的位fd */</span>
<span class="token keyword">int</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set<span class="token operator">*</span> fdset<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 测试 fdset 的位 fd s是否被设置 */</span></code></pre>

<p><code>nfds</code> 参数指定被监听的文件描述符的总数，通常被设置为 select 监听的<strong>所有文件描述符中的最大值加1</strong>，因为文件描述符是从0开始计数的</p>
<p><code>readfds</code> 、<code>writefds</code> 和 <code>exceptfds</code> 参数分别指向<strong>可读</strong>、<strong>可写</strong>和<strong>异常</strong>等事件对应的<strong>文件描述符集合</strong>，select 调用返回时，内核将修改它们来通知应用程序哪些文件描述符已经就绪</p>
<p><code>timeout</code> 参数用来设置 select 函数的超时时间，它是一个 <code>timeval</code> 结构类型的指针，采用指针参数是因为内核将修改它以告诉应用程序 select 等待了多久。不过我们不能完全信任 select 调用返回后的 <code>timeout</code> 值，比如调用失败时 <code>timeout</code> 值是不确定的，<code>timeval</code> 结构体的定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> tv_sec<span class="token punctuation">;</span>	<span class="token comment">/* 秒数 */</span>
    <span class="token keyword">long</span> tv_usec<span class="token punctuation">;</span>	<span class="token comment">/* 微妙数 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>如果给 <code>timeout</code> 传递 NULL，则 select 将一直阻塞，直到某个文件描述符就绪</p>
<p>select 成功时返回就绪（可读、可写和异常）文件描述符的<strong>总数</strong>。如果在超时时间内没有任何文件描述符就绪，select 将返回0。select 失败时返回-1并设置 errno。如果在 select 等待期间，程序接收到信号，则 select 立即返回-1，并设置 errno 为 <code>EINTR</code> </p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 同时接收普通数据和带外数据</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    fd_set read_fds<span class="token punctuation">;</span>
    fd_set exception_fds<span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>exception_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exception_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>connfd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>exception_fds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"selection failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of normal data: %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exception_fds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> MSG_OOB<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of oob data: %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="poll-系统调用"><a href="#poll-系统调用" class="headerlink" title="poll 系统调用"></a>poll 系统调用</h3><p>poll 系统调用和 select 类似，也是在指定时间内<strong>轮询</strong>一定数量的文件描述符，以测试其中是否有就绪者</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span>

<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token operator">*</span> fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>fds</code> 参数是一个 <code>pollfd</code> 结构类型的数组，它定义所有我们感兴趣的文件描述符上发生的可读、可写和异常等事件。<code>pollfd</code> 结构体的定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>				<span class="token comment">/* 文件描述符 */</span>
    <span class="token keyword">short</span> events<span class="token punctuation">;</span>		<span class="token comment">/* 注册的事件 */</span>
    <span class="token keyword">short</span> revents<span class="token punctuation">;</span>		<span class="token comment">/* 实际发生的事件, 由内核填充 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>其中， <code>fd</code> 成员指定文件描述符；<code>events</code> 成员告诉 poll 监听 <code>fd</code> 上的哪些事件，它是一系列事件的按位或；<code>revents</code> 成员则由内核修改，以通知应用程序 <code>fd</code> 上实际发生了哪些事件，poll 事件类型如下：</p>
<ul>
<li><strong>POLLIN</strong> : 数据可读（包括普通数据和优先数据）</li>
<li><strong>POLLRDNORM</strong>：普通数据可读</li>
<li><strong>POLLRDBAND</strong>：优先级带数据可读（Linux不支持）</li>
<li><strong>POLLRPI</strong>：高优先级数据可读，比如 TCP 带外数据</li>
<li><strong>POLLOUT</strong>：数据可写（包括普通数据和优先数据）</li>
<li><strong>POLLWRNORM</strong>：普通数据可写</li>
<li><strong>POLLWRBAND</strong>：优先级带数据可写</li>
<li><strong>POLLRDHUP</strong>：TCP 连接被对方关闭，或者对方关闭了写操作（它由GNU引入）</li>
<li><strong>POLLERR</strong> ：错误</li>
<li><strong>POLLHUP</strong>：挂起</li>
<li><strong>POLLNVAL</strong>：文件描述符没有打开</li>
</ul>
<p>自 Linux 内核 2.6.17 开始， GNU 为 poll 系统调用增加了一个 <strong>POLLRDHUP</strong> 事件，它在 socket 上接收到对方关闭连接的请求之后出发。<strong>但使用时我们需要在代码最开始处定义 <code>_GNU_SOURCE</code></strong></p>
<p><code>nfds</code> 参数指定被监听事件集合 <code>fds</code> 的大小，其类型 <code>nfds_t</code> 的定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token class-name">nfds_t</span><span class="token punctuation">;</span></code></pre>

<p><code>timeout</code> 参数指定 poll 的超时值，单位是毫秒。当 <code>timeout</code> 为 -1 时，poll 调用将永远阻塞，直到某个事件发生；当 <code>timeout</code> 为0时，poll 调用将立即返回</p>
<h3 id="epoll-系列系统调用"><a href="#epoll-系列系统调用" class="headerlink" title="epoll 系列系统调用"></a>epoll 系列系统调用</h3><h4 id="内核事件表"><a href="#内核事件表" class="headerlink" title="内核事件表"></a>内核事件表</h4><p>epoll 是 Linux 持有的 I/O 复用函数。它在实现和使用上与 select 、poll 有很大差异。epoll 使用一组函数来完成任务，而不是单个函数。把用户关系的文件描述符上的事件放在内核的一个事件表中，从而无需像 select 和 poll 那样每次调用都要重复传入文件描述符集或事件集。但 epoll 需要使用一个额外的文件描述符，来唯一标识内核中的这个事件表</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>

<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span></code></pre>

<p><code>size</code> 参数现在并不起作用，只是给内核一个提醒，告诉它事件表需要多大。该函数返回的文件描述符将作用于其他所有 epoll 系统调用的第一个参数，以指定要访问的内核事件表</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 操作内核事件表</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>

<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>fd</code> 参数是要操作的文件描述符， <code>op</code> 参数指定操作类型，有如下几种：</p>
<ul>
<li><strong>EPOLL_CTL_ADD</strong>：往事件表中注册 <code>fd</code> 上的事件</li>
<li><strong>EPOLL_CTL_MOD</strong> ：修改 <code>fd</code> 上的注册事件</li>
<li><strong>EPOLL_CTL_DEL</strong>：删除 <code>fd</code> 上的注册事件</li>
</ul>
<p><code>event</code> 参数指定事件，它是 <code>epoll_event</code> 结构指针类型，其定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">&#123;</span>
    __uint32_t events<span class="token punctuation">;</span>	<span class="token comment">/* epoll 事件 */</span>
    <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>	<span class="token comment">/* 用户数据 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>其中 <code>event</code> 成员描述事件类型。epoll 支持的类型和 poll 基本相同。<strong>表示 epoll 事件类型的宏是在 poll 对应的宏前加上 “E”<strong>，但 epoll 有两个额外的时间类型——</strong>EPOLLET</strong> 和 <strong>EPOLLONESHOT</strong>。</p>
<p><code>data</code> 成员用于存储用户数据，其类型 <code>epoll_data_t</code> 定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> ptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> u32<span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span></code></pre>

<p><code>epoll_data_t</code> 是一个<strong>联合体</strong>，其中四个成员中用的最多是 <code>fd</code> ，它指定事件所属的目标文件描述符。</p>
<p><code>epoll_ctl</code> 成功时返回0，失败则返回-1并设置 errno</p>
<h4 id="epoll-wait-函数"><a href="#epoll-wait-函数" class="headerlink" title="epoll_wait 函数"></a>epoll_wait 函数</h4><p>epoll 系列系统调用的主要接口是 epoll_wait 函数。它在一段超时时间内等待一组文件描述符上的事件：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>

<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>maxevents</code> 参数指定最多监听多少个事件，<strong>它必须大于0</strong></p>
<p><code>epfd</code> 即 epoll_create 返回的描述符</p>
<p><code>events</code> 是一个结构体数组，<strong>用于输出 epoll_wait 检测到的就绪事件</strong>，而不像 select 和 poll 的数组那样既用于传入用户注册的事件，又用于输出内核检测到的就绪事件。<strong>极大地提高了应用程序索引就绪文件描述符的效率</strong></p>
<h4 id="LT-和-ET-模式"><a href="#LT-和-ET-模式" class="headerlink" title="LT 和 ET 模式"></a>LT 和 ET 模式</h4><p>epoll 对文件描述符的操作有两种模式：<strong>LT（Level Trigger，电平触发）模式</strong>和 <strong>ET（Edge Trigger，边沿触发）模式</strong>。LT 模式是默认的工作模式，而当往 epoll 内核事件表中注册一个文件描述符上的 <strong>EPOLLET</strong> 事件时，epoll 将以 ET 模式来操作该文件描述符。ET 模式是 epoll 的高效工作模式</p>
<p>对于采用 LT 工作模式的文件描述符，当 epoll_wait 检测到其上有事件发生并将此事件通知应用程序后，<strong>应用程序可以不立即处理该事件</strong>。</p>
<p>对于采用 ET 工作模式的文件描述符，<strong>应用程序必须立即处理该事件</strong>，因为后序的 epoll_wait 调用将不再向应用程序通知这一事件。<strong>ET 模式在很大程度上降低了同一个 epoll 事件被重复触发的次数，因此效率要比 LT 模式高</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENT_NUMBER</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> epoll_event<span class="token punctuation">;</span>

<span class="token comment">/* 将文件描述符设置成非阻塞的 */</span>
<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 将文件描述符 fd 上的 EPOLLIN 注册到 epollfd 指示的 epoll 内核事件表中, 根据参数 enable_et 指定是否对 fd 启用 ET 模式 */</span>
<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> bool enable_et<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable_et<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        event<span class="token punctuation">.</span>events <span class="token operator">|=</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* LT 模式的工作流程 */</span>
<span class="token keyword">void</span> <span class="token function">lt</span><span class="token punctuation">(</span>epoll_event<span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* 只要socket读缓冲中还有未读出的数据，这段代码就被触发 */</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"event trigger once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of content: %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"something else happened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">/* ET 模式的工作流程 */</span>
<span class="token keyword">void</span> <span class="token function">et</span><span class="token punctuation">(</span>epoll_event<span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* 这段代码不会被重复触发，所以我们循环读取数据，以确保把 socket 读
             * 缓存中的所有数据读出*/</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"event trigger onece\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EWOULDBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read later\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of content: %s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"something else happened\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mode <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> <span class="token string">"ET"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">et</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">lt</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>注意</strong>：每个使用 ET 模式的文件描述符都应该是<strong>非阻塞</strong>的。如果文件描述符是阻塞的，那么读或写操作将会因为没有后续的事件而一直处于阻塞状态（<strong>饥渴状态</strong>）</p>
<h4 id="EPOLLONESHOT-事件"><a href="#EPOLLONESHOT-事件" class="headerlink" title="EPOLLONESHOT 事件"></a>EPOLLONESHOT 事件</h4><p>即使我们<strong>使用 ET 模式，一个 socket 上的某个事件还是可能被触发多次</strong>。这在并发程序中就会引起一个问题。比如一个线程（或进程）在读取完某个 socket 上的数据后开始处理这些数据，而在数据的处理过程中该 socket 上又有新数据可读（<strong>EPOLLIN</strong> 再次被触发），此时另外一个线程被唤醒来读取这些新的数据。于是就出现了两个线程同时操作一个线程处理。这一点可以使用 epoll 的 <strong>EPOLLONESHOT</strong> 事件实现</p>
<p>对于注册了 <strong>EPOLLONESHOT</strong> 事件的文件描述符，<strong>操作系统最多触发其上注册的一个可读、可写或者异常事件，且只触发一次</strong>，除非我们使用 <code>epoll_ctl</code> 函数重置该文件描述符上注册的 <strong>EPOLLONESHOT</strong> 事件。这样，当一个线程在处理某个 socket 时，其他线程是不可能有机会操作该 socket 的。注册了 <strong>EPOLLONESHOT</strong> 事件的 socket 一旦被某个线程处理完毕，该线程就应该立即重置这个 socket 上的 <strong>EPOLLONESHOT</strong> 事件，以确保这个 socket 下一次可读时，其 <strong>EPOLLIN</strong> 事件能被触发，进而让其他工作线程有机会继续处理这个 socket</p>
<pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;sys&#x2F;types.h&gt;
#include &lt;sys&#x2F;socket.h&gt;
#include &lt;netinet&#x2F;in.h&gt;
#include &lt;arpa&#x2F;inet.h&gt;
#include &lt;assert.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys&#x2F;epoll.h&gt;
#include &lt;pthread.h&gt;

#define MAX_EVENT_NUMBER 1024
#define BUFFER_SIZE 1024

struct fds &#123;
    int epollfd;
    int sockfd;
&#125;;

int setnonblocking(int fd) &#123;
    int old_option &#x3D; fcntl(fd, F_GETFL);
    int new_option &#x3D; old_option | O_NONBLOCK;
    fcntl(fd, F_SETFL, new_option);
    return old_option;
&#125;

void addfd(int epollfd, int fd, bool oneshot) &#123;
    epoll_event event;
    event.data.fd &#x3D; fd;
    event.events &#x3D; EPOLLIN | EPOLLET;
    if (oneshot) &#123;
        event.events |&#x3D; EPOLLONESHOT;
    &#125;
    epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &amp;event);
    setnonblocking(fd);
&#125;

void reset_oneshot(int epollfd, int fd) &#123;
    epoll_event event;
    event.data.fd &#x3D; fd;
    event.events &#x3D; EPOLLIN | EPOLLET | EPOLLONESHOT;
    epoll_ctl(epollfd, EPOLL_CTL_MOD, fd, &amp;event);
&#125;

void* worker(void* arg) &#123;
    int sockfd &#x3D; ( (fds*)arg)-&gt;sockfd;
    int epollfd &#x3D; ( (fds*)arg)-&gt;epollfd;
    printf(&quot;start new thread to recevie data on fd: %d\n&quot;, sockfd);
    char buf[BUFFER_SIZE];
    memset(buf, &#39;\0&#39;, BUFFER_SIZE);

    while (1) &#123;
        int ret &#x3D; recv(sockfd, buf, BUFFER_SIZE - 1, 0);
        if (ret &#x3D;&#x3D; 0) &#123;
            close(sockfd);
            printf(&quot;foreiner closed the connection\n&quot;);
            break;
        &#125;
        else if (ret &lt; 0) &#123;
            if (errno &#x3D;&#x3D; EAGAIN) &#123;
                reset_oneshot(epollfd, sockfd);
                printf(&quot;read later\n&quot;);
                break;
            &#125;
        &#125;
        else &#123;
            printf(&quot;get content: %s\n&quot;, buf);
            &#x2F;* 休眠5s, 模拟数据处理过程  *&#x2F;
            sleep(5);
        &#125;
    &#125;
    printf(&quot;end thread receiving data on fd: %d\n&quot;, sockfd);
    pthread_exit(0);
&#125;

int main(int argc, char* argv[]) &#123;
    if (argc &lt;&#x3D; 2) &#123;
        return 1;
    &#125;

    const char* ip &#x3D; argv[1];
    int port &#x3D; atoi(argv[2]);

    int ret &#x3D; 0;
    struct sockaddr_in address;
    bzero(&amp;address, sizeof(address));
    address.sin_family &#x3D; AF_INET;
    address.sin_port &#x3D; htons(port);
    inet_pton(AF_INET, ip, &amp;address.sin_addr);

    int listenfd &#x3D; socket(PF_INET, SOCK_STREAM, 0);

    ret &#x3D; bind(listenfd, (struct sockaddr*)&amp;address, sizeof(address));
    assert(ret !&#x3D; -1);

    ret &#x3D; listen(listenfd, 5);
    assert(ret !&#x3D; -1);

    epoll_event events[MAX_EVENT_NUMBER];
    int epollfd &#x3D; epoll_create(5);
    assert(epollfd !&#x3D; -1);

    addfd(epollfd, listenfd, false);

    while (1) &#123;
        int ret &#x3D; epoll_wait(epollfd, events, MAX_EVENT_NUMBER, -1);
        if (ret &lt; 0) &#123;
            printf(&quot;epoll failure\n&quot;);
            break;
        &#125;

        for (int i &#x3D; 0; i &lt; ret; i++) &#123;
            int sockfd &#x3D; events[i].data.fd;
            if (sockfd &#x3D;&#x3D; listenfd) &#123;
                int connfd &#x3D; accept(listenfd, NULL, NULL);
                addfd(epollfd, connfd, true);
            &#125;
            else if (events[i].events &amp; EPOLLIN) &#123;
                pthread_t thread;
                fds fds_for_new_worker;
                fds_for_new_worker.epollfd &#x3D; epollfd;
                fds_for_new_worker.sockfd &#x3D; sockfd;

                pthread_create(&amp;thread, NULL, worker, (void*)&amp;fds_for_new_worker);
            &#125;
            else &#123;
                printf(&quot;something else happened\n&quot;);
            &#125;
        &#125;
    &#125;
    close(listenfd);

    return 0;
&#125;</code></pre>





<h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><p>信号是由用户、系统或者进程发送给目标进程的信息，以通知目标进程某个状态的改变或系统异常</p>
<ul>
<li>对于前台进程，用户可以通过输入特殊的终端字符来给它发送信号。比如输入 Ctrl + C通常会给进程发送一个终端信号（<strong>SIGINT</strong>），也可以通过 kill 命令发送指定信号到指定进程 <code>kill -SIGxxx pid</code> </li>
<li>系统异常。比如浮点异常和非法内存段访问</li>
<li>系统状态变化。比如 <code>alarm</code> 定时器到期将引起 <strong>SIGALRM</strong> 信号</li>
<li>运行 kill 命令或调用 kill 函数</li>
</ul>
<p>服务器程序必须处理（或至少忽略）一些常见的信号，<strong>以免异常终止</strong></p>
<h3 id="发送信号"><a href="#发送信号" class="headerlink" title="发送信号"></a>发送信号</h3><p>Linux 下，一个进程给其他进程发送信号的 API 是 kill 函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token comment">// 该函数把信号发送给目标进程: 目标进程由 pid 参数指定</span>
<span class="token comment">// 成功时返回0，失败时返回 -1并设置 errno</span>
<span class="token keyword">int</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
pid > 0 : 信号发送给 PID 为 pid 的进程
pid = 0 : 信号发送给本进程组内的其他进程
pid = -1: 信号发送给除 init 进程外的所有进程，但发送这需要拥有对目标进程发送信号的权限
pid &lt; -1: 信号发送给组 ID 为 -pid 的进程组中的所有成员
*/</span>

<span class="token comment">/*
sig = 0 : kill 函数不发送任何信号(但可以用来检测目标进程或进程组是否存在, 但是不靠谱)
*/</span>

<span class="token comment">/* errno 的可能值
EINVAL : 无效的信号
EPERM  : 该进程没有权限发送信号给任何一个目标进程
ESRCH  : 目标进程或进程组不存在
*/</span></code></pre>



<h3 id="信号处理方式"><a href="#信号处理方式" class="headerlink" title="信号处理方式"></a>信号处理方式</h3><p>目标进程在收到信号时，需要定义一个接收函数来处理</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>__sighandler_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 信号处理函数应该是可重入的，否则很容易引发一些竞态条件</span>
<span class="token comment">// 所以在信号处理函数中严禁调用一些不安全的函数</span></code></pre>

<p>除了用户自定义信号处理函数为，还有信号的其它两种处理方式</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/signum.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIG_DFL</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIG_IGN</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span></code></pre>

<p><strong>SIG_IGN</strong> 表示忽略目标信号，<strong>SIG_DFL</strong> 表示使用信号的默认处理方式</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenj_freedom/article/details/86489043?utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.essearch_pc_relevant&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.essearch_pc_relevant">Linux标准信号表</a></p>
<h3 id="中断系统调用"><a href="#中断系统调用" class="headerlink" title="中断系统调用"></a>中断系统调用</h3><p>如果程序在执行处于阻塞状态的系统调用时接收到信号，并且我们为该信号设置了信号处理函数，则默认情况下系统调用将被中断，并且 errno 将被设置为 <strong>EINTR</strong>。我们可以使用 <code>sigaction</code> 函数为信号设置 <strong>SA_RESTART</strong> 标志以自动重启被该信号中断的系统调用</p>
<h3 id="signal-系统调用"><a href="#signal-系统调用" class="headerlink" title="signal 系统调用"></a>signal 系统调用</h3><p>为一个信号设置处理函数</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

_sighandler_t <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> _sighandler_t _handler<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>sig</code> 参数指出要捕获的信号类型。<code>_handler</code> 参数是 <code>_sighandler_t</code> 类型的函数指定，用于指定信号 <code>sig</code> 的处理函数，调用出错时返回 <strong>SIG_ERR</strong>，并设置 errno</p>
<h3 id="sigaction-系统调用"><a href="#sigaction-系统调用" class="headerlink" title="sigaction 系统调用"></a>sigaction 系统调用</h3><p>设置信号处理函数<strong>更健壮</strong>的接口是如下的系统调用：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span><span class="token operator">*</span> act<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sigaction</span><span class="token operator">*</span> oact<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>sig</code> 参数指出要捕获的信号类型，<code>act</code> 参数指定新的信号处理方式，<code>oact</code> 参数则输出信号先前的处理方式（如果不为 NULL 的话）。<code>act</code> 和 <code>oact</code> 都是 <code>sigaction</code> 结构体类型的指针，其定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__USE_POSIX199309</span></span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
        _sighandler_t sa_handler<span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">siginfo_t</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    _sigaction_handler<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">sa_handler</span>   <span class="token expression">__sigaction_handler<span class="token punctuation">.</span>sa_handler</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">sa_sigaction</span> <span class="token expression">__sigaction_handler<span class="token punctuation">.</span>sa_sigaction</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elseif</span></span>
    
    _sigset_t sa_mask<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sa_flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><code>sa_hander</code> 成员指定信号处理函数</p>
<p><code>sa_mask</code> 成员设置进程的信号掩码，以指定哪些信号不能发送给本进程</p>
<p><code>sa_flags</code> 成员用于设置程序收到信号时的行为，常用的有 :</p>
<ul>
<li><strong>SA_NOCLDWAIT</strong> : 如果 sigaction 的 <code>sig</code> 参数是<strong>SIGCHLD</strong>，则设置该标志表示子进程结束时<strong>不产生僵尸进程</strong></li>
<li><strong>SA_RESTART</strong> ：重新调用被该信号终止的系统调用</li>
</ul>
<h3 id="信号集函数"><a href="#信号集函数" class="headerlink" title="信号集函数"></a>信号集函数</h3><p>Linux 使用数据结构 <code>sigset_t</code> 来表示一组信号：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/sigset.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SIGSET_NWORDS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __val<span class="token punctuation">[</span>_SIGSET_NWORDS<span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span> __sigset_t<span class="token punctuation">;</span></code></pre>

<p><code>sigset_t</code> 实际上是一个长整型数组，数组的每个元素的每个位表示一个信号。Linux 提供了如下一组函数来设置、修改、删除和查询信号集：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token keyword">int</span> <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">/* 清空信号集 */</span>
<span class="token keyword">int</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 在信号集中设置所有信号(常用来设置sa_mask) */</span>
<span class="token keyword">int</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">,</span> <span class="token keyword">int</span> _signo<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 将信号 _signo 添加至信号集中 */</span>
<span class="token keyword">int</span> <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">,</span> <span class="token keyword">int</span> _signo<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/* 将信号 _signo 从信号集中删除 */</span>
<span class="token keyword">int</span> <span class="token function">sigismember</span><span class="token punctuation">(</span>_const <span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">,</span> <span class="token keyword">int</span> _signo<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">/* 测试 _signo 是否在信号集中 */</span></code></pre>



<h3 id="进程信号掩码"><a href="#进程信号掩码" class="headerlink" title="进程信号掩码"></a>进程信号掩码</h3><p>我们可以利用 <code>sigaction</code> 结构体的 <code>sa_mask</code> 成员来设置进程的信号掩码，此外如下函数也可以用于设置或查看进程的信号掩码：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token keyword">int</span> <span class="token function">sigprocmask</span><span class="token punctuation">(</span><span class="token keyword">int</span> _how<span class="token punctuation">,</span> _const <span class="token class-name">sigset_t</span><span class="token operator">*</span> _set<span class="token punctuation">,</span> <span class="token class-name">sigset_t</span><span class="token operator">*</span> _oset<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>_set</code> 参数指定新的信号掩码，<code>_oset</code> 参数则输出原来的信号掩码（如果不为NULL的话）</p>
<p>如果<code>_set</code> 参数不为NULL，则 <code>_how</code> 参数指定设置进程信号掩码的方式：</p>
<ul>
<li><strong>SIG_BLOCK</strong> : 新的进程信号掩码是其当前值和 <code>_set</code> 指定信号集的并集</li>
<li><strong>SIG_UNBLOCK</strong> : 新的进程信号掩码是其当前值和 <code>~_set</code> 信号集的交集，因此 <code>_set</code> 指定的信号集将不被屏蔽</li>
<li><strong>SIG_SETMASK</strong> : 直接将进程信号掩码设置为 <code>_set</code> </li>
</ul>
<p>如果 <code>_set</code> 为 NULL，则进程信号掩码不变，此时依然可以用 <code>_oset</code> 来获得进程当前的信号掩码</p>
<p><code>sigprocmask</code> 成功时返回0，失败则返回 -1 并设置 errno</p>
<h3 id="被挂起的信号"><a href="#被挂起的信号" class="headerlink" title="被挂起的信号"></a>被挂起的信号</h3><p>设置进程信号掩码后，被屏蔽的信号将不能被进程接收。如果给进程发送一个被屏蔽的信号，则操作系统将该信号设置为进程的一个被挂起的好，如果我们取消对被挂起信号的屏蔽，则它能立即被进程接收到</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 好的进程当前被挂起的信号集</span>

<span class="token keyword">int</span> <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token class-name">sigset_t</span><span class="token operator">*</span> set<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>set</code> 参数用于保存被挂起的信号集。成功时返回0，失败时返回-1并设置 errno</p>
<h3 id="统一事件源"><a href="#统一事件源" class="headerlink" title="统一事件源"></a>统一事件源</h3><p>信号是一种异步事件：信号处理函数和主程序的主循环是两条不同的执行路线。统一事件源即统一处理信号和 I/O 事件。信号处理函数通常使用管道来讲信号“传递”给主循环，然后主循环再根据接收到的信号值执行目标信号对应的逻辑代码</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENT_NUMBER</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> epoll_event<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span> 
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 信号处理函数 */</span>
<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 每个信号值占一个字节 */</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 设置信号的处理函数 */</span>
<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"本进程的PID为: %d\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 设置一些信号的处理函数 */</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    bool stop_server <span class="token operator">=</span> false<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"就绪的文件描述符有%d个\n"</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 添加客户连接，不过这里没有对客户连接进行处理 */</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">/* 当信号触发时，通过管道传输信号信息，做相应处理 */</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"信号触发"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">case</span> SIGCHLD<span class="token operator">:</span>
                            <span class="token keyword">case</span> SIGHUP<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"我被挂起了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>
                            <span class="token keyword">case</span> SIGINT<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"我被中断了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    stop_server <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fds\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="网络编程相关信号"><a href="#网络编程相关信号" class="headerlink" title="网络编程相关信号"></a>网络编程相关信号</h3><ul>
<li><strong>SIGHUP</strong> : 当挂起进程的控制终端时，<strong>SIGHUP</strong> 信号将被触发</li>
<li><strong>SIGPIPE</strong> : 默认情况下，往一个读端关闭的管道或 socket 连接中写数据将引发 <strong>SIGPIPE</strong> 信号。程序接收到 <strong>SIGPIPE</strong> 信号的默认行为是结束进程，而我们绝对不希望因为错误的写操作而导致程序退出。引起 <strong>SIGPIPE</strong> 信号的写操作将设置 errno 为 <strong>EPIPE</strong>，我们可以使用 send 函数的 <strong>MSG_NOSIGNAL</strong> 标志来禁止写操作触发 SIGPIPE 信号，这种情况下，我们应该使用 send 函数反馈的 errno 值来判断管道或者 socket 连接的读端是否已经关闭</li>
<li><strong>SIGURG</strong> : 程序带外数据到达</li>
</ul>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 用 SIGURG 检测带外数据是否到达</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> connfd<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sig_urg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUF_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> MSG_OOB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of oob data '%s'\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sig_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">addsig</span><span class="token punctuation">(</span>SIGURG<span class="token punctuation">,</span> sig_urg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> F_SETOWN<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUF_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 接收普通数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of normal data '%s'\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>网络程序需要处理的<strong>第三类事件</strong>是定时事件，比如定期检测一个客户连接的活动状态。服务器程序通常管理这众多定时事件，因此有效地组织这些定时事件，使之能在预期的时间点被触发且不影响服务器的主要逻辑，对于服务器的性能有着至关重要的影响。为此，我们要将每个定时器事件分别封装成定时器，并使用某种容器类数据结构将所有的定时器串联起来，以<strong>实现对定时事件的统一管理</strong></p>
<p>定时是指在一段时间之后触发某段代码的机制，我们可以在这段代码中依次处理所有到期的定时器。Linux 提供了三种定时方法：</p>
<ul>
<li>socket 选项 <strong>SO_RCVTIMEO</strong> 和 <strong>SO_SNDTIMEO</strong></li>
<li><strong>SIGALRM</strong> 信号</li>
<li>I/O 复用系统调用超时函数</li>
</ul>
<h3 id="socket-选项-SO-RCVTIMEO-和-SO-SNDTIMEO"><a href="#socket-选项-SO-RCVTIMEO-和-SO-SNDTIMEO" class="headerlink" title="socket 选项 SO_RCVTIMEO 和 SO_SNDTIMEO"></a>socket 选项 SO_RCVTIMEO 和 SO_SNDTIMEO</h3><p>它们分别用来设置 socket 接收数据超时时间和发送数据超时时间。因此，这两个选项仅对于数据接收和发送相关的 socket 专用系统调用有效</p>
<ul>
<li>send、sendmsg、connect : <strong>SO_SNDTIMEO</strong></li>
</ul>
<p><strong>超时行为</strong>：返回-1并设置errno，send、sendmsg(<strong>EAGAIN</strong> 或 <strong>EWOULDBLOCK</strong>)，connect(<strong>EINPROGRESS</strong>)</p>
<ul>
<li>recv、recvmsg、accept : <strong>SO_RCVTIMEO</strong></li>
</ul>
<p><strong>超时行为</strong>：返回-1并设置errno，recv、recvmsg、accept(<strong>EAGAIN</strong> 或 <strong>EWOULDBLOCK</strong>)</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 设置 connect 超时时间</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span>                                                                                                       </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">int</span> <span class="token function">timeout_connect</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> timeout<span class="token punctuation">;</span>
    timeout<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> time<span class="token punctuation">;</span>
    timeout<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token class-name">socklen_t</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_SNDTIMEO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINPROGRESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connecting timeout, process timeout logic\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"error occur when connecting to server\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> sockfd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">timeout_connect</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>                                                                                         </code></pre>



<h3 id="SIGALRM-信号"><a href="#SIGALRM-信号" class="headerlink" title="SIGALRM 信号"></a>SIGALRM 信号</h3><p>由 <code>alarm</code> 和 <code>setitimer</code> 函数设置的实时闹钟一旦超时，将触发 <strong>SIGALRM</strong> 信号。因此，我们可以利用该信号的信号处理函数来处理定时任务。但是，如果要处理多个定时任务，我们就需要不断地触发 <strong>SIGALRM</strong> 信号，并在其信号处理函数中执行到期的任务。一般而言， <strong>SIGALRM</strong> 信号按照固定的频率生成，即由 <code>alarm</code> 或 <code>setitimer</code> 函数设置的定时周期 T 保持不变。</p>
<h4 id="基于升序链表的定时器"><a href="#基于升序链表的定时器" class="headerlink" title="基于升序链表的定时器"></a>基于升序链表的定时器</h4><p>定时器通常至少要包含两个成员：一个<strong>超时时间</strong>（相对时间或绝对时间）和一个任务<strong>回调函数</strong>。有的时候还可能包含回调函数被执行时需要传入的参数, 以及是否重启定时器等信息。</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// lst_timer.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LST_TIMER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LST_TIMER</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">64</span></span></span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">client_data</span> <span class="token punctuation">&#123;</span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    time_t expire<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span> user_data<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> prev<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span> next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">sort_timer_lst</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">head</span><span class="token punctuation">(</span><span class="token keyword">new</span> util_timer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token keyword">new</span> util_timer<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>   
        head<span class="token operator">-></span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        tail<span class="token operator">-></span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>   

    <span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>   
        util_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            head <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
            <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        util_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> head<span class="token operator">-></span>next<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-></span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                timer<span class="token operator">-></span>next <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
                timer<span class="token operator">-></span>prev <span class="token operator">=</span> tmp<span class="token operator">-></span>prev<span class="token punctuation">;</span>
                tmp<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                tmp<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* 应该插在最尾部 */</span>
        timer<span class="token operator">-></span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>prev <span class="token operator">=</span> tail<span class="token operator">-></span>prev<span class="token punctuation">;</span>
        tail<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        tail<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        timer<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
        timer<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* 检查升序链表中是否有超时任务 */</span>
    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timer tick\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 获得系统当前时间 */</span>

        util_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> head<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            tmp<span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-></span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            util_timer<span class="token operator">*</span> del <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
            <span class="token function">del_timer</span><span class="token punctuation">(</span>del<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
   util_timer<span class="token operator">*</span> head<span class="token punctuation">;</span>
   util_timer<span class="token operator">*</span> tail<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>

<p>判断定时任务到期的依据是定时器的 expire 值小于当前的系统时间</p>
<h4 id="处理非活动连接"><a href="#处理非活动连接" class="headerlink" title="处理非活动连接"></a>处理非活动连接</h4><p>在应用层实现类似于 <strong>KEEPALIVE</strong> 的机制，以管理所有长时间处于非活动状态的连接</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 关闭非活动连接</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lst_timer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FD_LIMIT</span> <span class="token expression"><span class="token number">65535</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENT_NUMBER</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMESLOT</span> <span class="token expression"><span class="token number">5</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> sort_timer_lst timer_lst<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span> 
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    timer_lst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span> user_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-></span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>listenfd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epollfd = %d\n"</span><span class="token punctuation">,</span> epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool stop_server <span class="token operator">=</span> false<span class="token punctuation">;</span>

    client_data<span class="token operator">*</span> users <span class="token operator">=</span> new client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    bool timeout <span class="token operator">=</span> false<span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
                <span class="token class-name">socklen_t</span> client_addlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>

                util_timer<span class="token operator">*</span> timer <span class="token operator">=</span> new util_timer<span class="token punctuation">;</span>
                timer<span class="token operator">-></span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                timer<span class="token operator">-></span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
                <span class="token class-name">time_t</span> cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timer<span class="token operator">-></span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                timer_lst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    timeout <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    stop_server <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                util_timer<span class="token operator">*</span> timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        timer_lst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">time_t</span> cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        timer<span class="token operator">-></span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"adjust timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">/* 调整timer在链表中的位置 */</span>
                        util_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
                        timer<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>
                        timer<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
                        bool isLast <span class="token operator">=</span> true<span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-></span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                timer<span class="token operator">-></span>next <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
                                timer<span class="token operator">-></span>prev <span class="token operator">=</span> tmp<span class="token operator">-></span>prev<span class="token punctuation">;</span>
                                tmp<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                                tmp<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                                isLast <span class="token operator">=</span> false<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isLast<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                           timer<span class="token operator">-></span>next <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
                           timer<span class="token operator">-></span>prev <span class="token operator">=</span> tmp<span class="token operator">-></span>prev<span class="token punctuation">;</span>
                           tmp<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                           tmp<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// other</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delete <span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h3 id="高性能定时器"><a href="#高性能定时器" class="headerlink" title="高性能定时器"></a>高性能定时器</h3><h4 id="时间轮"><a href="#时间轮" class="headerlink" title="时间轮"></a>时间轮</h4><p>模拟时钟，每隔一段时间指针就想下一个槽转动，每个槽都有一个指向定时器链表的指针，每条链表上的定时器具有相同的特征：它们的定时时间相差 N * si，其中 N 是槽的个数，si 是槽之间的时间间隔。时间轮正是利用这个关系将定时器散列到不同的链表中。假如现在指针指向槽 cs，我们要添加一个定时时间为 ti 的定时器，则该定时器将被插入槽 <code>ts = (cs + (ti / si)) % N</code> 对应的链表中</p>
<p>对时间轮而言，要提高定时精度，就要使 si 值<strong>足够小</strong>；要提高执行效率，则要求 N 值<strong>足够大</strong></p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// time_wheel_timer.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">TIME_WHEEL_TIMER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIME_WHEEL_TIMER</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">64</span></span></span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">client_data</span> <span class="token punctuation">&#123;</span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span> <span class="token punctuation">&#123;</span>
 
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">tw_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> rot<span class="token punctuation">,</span> <span class="token keyword">int</span> ts<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">rotation</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">time_slot</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    tw_timer<span class="token operator">*</span> next<span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span> prev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rotation<span class="token punctuation">;</span>
    <span class="token keyword">int</span> time_slot<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span> user_data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">time_wheel</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">cur_slot</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>   
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>   
    <span class="token punctuation">&#125;</span>   

    <span class="token operator">~</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            tw_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
                <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    tw_timer<span class="token operator">*</span> <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> SI<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            ticks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            ticks <span class="token operator">=</span> timeout <span class="token operator">/</span> SI<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> rotation <span class="token operator">=</span> ticks <span class="token operator">/</span> N<span class="token punctuation">;</span>

        <span class="token comment">// 算上偏移量</span>
        <span class="token keyword">int</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>cur_slot <span class="token operator">+</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span>

        tw_timer<span class="token operator">*</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">tw_timer</span><span class="token punctuation">(</span>rotation<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add timer, rotation is %d, ts is %d, cur_slot is %d\n"</span><span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            timer<span class="token operator">-></span>next <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">;</span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>tw_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> ts <span class="token operator">=</span> timer<span class="token operator">-></span>time_slot<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-></span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            timer<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> timer<span class="token operator">-></span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                timer<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> timer<span class="token operator">-></span>prev<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        tw_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current slot is %d\n"</span><span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tick timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-></span>rotation <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token operator">--</span><span class="token punctuation">(</span>tmp<span class="token operator">-></span>rotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                tmp<span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-></span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete header in cur_slot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token operator">-></span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    tmp<span class="token operator">-></span>prev<span class="token operator">-></span>next <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        tmp<span class="token operator">-></span>next<span class="token operator">-></span>prev <span class="token operator">=</span> tmp<span class="token operator">-></span>prev<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    tw_timer<span class="token operator">*</span> tmp2 <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                    tmp <span class="token operator">=</span> tmp2<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        cur_slot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>cur_slot<span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> SI <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span> slots<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cur_slot<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>



<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"time_wheel_timer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FD_LIMIT</span> <span class="token expression"><span class="token number">65535</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENT_NUMBER</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMESLOT</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> time_wheel tw<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    tw<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span> user_data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-></span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"closee fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-></span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    client_data<span class="token operator">*</span> users <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
                socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
                <span class="token comment">// 注意这里的超时时间是相对时间而不是绝对时间，成员方法会计算偏移量的</span>
                tw_timer<span class="token operator">*</span> timer <span class="token operator">=</span> tw<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                timer<span class="token operator">-></span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                timer<span class="token operator">-></span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// handle the error</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>

                    <span class="token punctuation">&#125;</span>   <span class="token comment">// for : ret</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                tw_timer<span class="token operator">*</span> timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            tw<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        tw<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 如果某个客户连接上有数据可读</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// 延长超时时间(先删除原来的，再添加新的)</span>
                        users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                        tw<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tw_timer<span class="token operator">*</span> new_timer <span class="token operator">=</span> tw<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        new_timer<span class="token operator">-></span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        new_timer<span class="token operator">-></span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
                        users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> new_timer<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>   <span class="token comment">// for : number</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>工作模式</strong>：时间轮指针按固定周期转动，当有客户连接时，将其添加到对应的位置。若规定时间内客户没有响应，则断开客户连接；若客户响应，则重设客户的超时时间（相对时间）</p>
<h4 id="时间堆"><a href="#时间堆" class="headerlink" title="时间堆"></a>时间堆</h4><p>使用另一种思路：将所有定时器中超时时间<strong>最小</strong>的一个定时器的超时值作为心搏间隔。这样，一旦心搏函数 tick 被调用，超时时间最小的定时器必然到期，我们就可以在 tick 函数处理该定时器。然后再从剩余的定时器中找出时间最小的一个，并将这段最小时间设置为下一次心搏间隔。</p>
<p><strong>最小堆</strong>很适合处理这种定时方案</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// min_heap.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MIN_HEAP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_HEAP</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>exception<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">64</span></span></span>

<span class="token keyword">class</span> <span class="token class-name">heap_timer</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">client_data</span> <span class="token punctuation">&#123;</span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    heap_timer<span class="token operator">*</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">heap_timer</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">heap_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> delay<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">+</span> delay<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    time_t expire<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span> user_data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">time_heap</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">time_heap</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">capacity</span><span class="token punctuation">(</span>cap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cur_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        array <span class="token operator">=</span> <span class="token keyword">new</span> heap_timer<span class="token operator">*</span> <span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> capacity<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">time_heap</span><span class="token punctuation">(</span>heap_timer<span class="token operator">*</span><span class="token operator">*</span> init_array<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">cur_size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">capacity</span><span class="token punctuation">(</span>cap<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cap <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        array <span class="token operator">=</span> <span class="token keyword">new</span> heap_timer<span class="token operator">*</span> <span class="token punctuation">[</span>capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>array<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> capacity<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> init_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/* 对数组中第 0 ~ [(cur_size - 1) / 2] 个元素执行下滤操作 */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>cur_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">percolate_down</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token operator">~</span><span class="token function">time_heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cur_size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>heap_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_size <span class="token operator">>=</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">int</span> hole <span class="token operator">=</span> cur_size<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>hole <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            parent <span class="token operator">=</span> <span class="token punctuation">(</span>hole <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token operator">-></span>expire <span class="token operator">&lt;=</span> timer<span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            array<span class="token punctuation">[</span>hole<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
            hole <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>heap_timer<span class="token operator">*</span> timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        timer<span class="token operator">-></span>cb_func <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>   <span class="token comment">// 延迟销毁</span>
    <span class="token punctuation">&#125;</span>

    heap_timer<span class="token operator">*</span> <span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">pop_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">delete</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span><span class="token operator">--</span>cur_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">percolate_down</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        heap_timer<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-></span>expire <span class="token operator">></span> cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>cb_func<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">cb_func</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-></span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token function">pop_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> <span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> cur_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">percolate_down</span><span class="token punctuation">(</span><span class="token keyword">int</span> hole<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        heap_timer<span class="token operator">*</span> temp <span class="token operator">=</span> array<span class="token punctuation">[</span>hole<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> child<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>child <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> hole <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> cur_size<span class="token punctuation">;</span> hole <span class="token operator">=</span> child<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            child <span class="token operator">=</span> hole <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 左儿子</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> cur_size <span class="token operator">&amp;&amp;</span> array<span class="token punctuation">[</span>child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-></span>expire <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token operator">++</span>child<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token operator">-></span>expire <span class="token operator">&lt;</span> temp<span class="token operator">-></span>expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 注意这里是temp->expire, 我们没有作实际的交换</span>
                array<span class="token punctuation">[</span>hole<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        array<span class="token punctuation">[</span>hole<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 两倍扩容</span>
    <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        heap_timer<span class="token operator">*</span><span class="token operator">*</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> heap_timer<span class="token operator">*</span> <span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> capacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>temp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> capacity<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> cur_size<span class="token punctuation">)</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
        array <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    heap_timer<span class="token operator">*</span><span class="token operator">*</span> array<span class="token punctuation">;</span>
    <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cur_size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>





<h2 id="多进程编程"><a href="#多进程编程" class="headerlink" title="多进程编程"></a>多进程编程</h2><h3 id="fork-系统调用"><a href="#fork-系统调用" class="headerlink" title="fork 系统调用"></a>fork 系统调用</h3><p>Linux 下创建新进程的系统调用:</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>该函数的每次调用都返回两次，<strong>在父进程中返回的是子进程的 PID ，在子进程中则返回 0</strong></p>
<p>fork 函数复制当前进程，在内核进程表中创建一个新的进程表项，新进程的 PPID 被设置成原进程的 PID，<strong>信号位图被清除</strong>（原进程设置的信号处理函数不再对新进程起作用）；子进程的代码与父进程完全相同，同时它还会<strong>复制父进程的数据</strong>（堆、栈和静态数据），因此，如果我们在程序中分配了大量内存，那么使用 fork 时应当十分谨慎，尽量避免没必要的内存分配和数据复制；创建子进程后，父进程中打开的<strong>文件描述符默认在子进程中也是打开的</strong>，且文件描述符的引用计数加1</p>
<h3 id="处理僵尸进程"><a href="#处理僵尸进程" class="headerlink" title="处理僵尸进程"></a>处理僵尸进程</h3><p>当子进程结束运行时，内核不会立即释放该进程的进程表表项，以满足父进程后续对该子进程退出信息的查询（如果父进程还在运行）</p>
<ol>
<li>在子进程结束运行之后，父进程读取其退出状态之前，我们称该子进程处于<strong>僵尸态</strong></li>
<li>另一种使子进程进入僵尸态的情况是：父进程结束或者异常终止，而子进程继续运行。此时由 <code>init</code> 进程接管该子进程</li>
</ol>
<p>如果父进程没有正确地处理子进程的返回信息，子进程都将停留在僵尸态，并<strong>占据着内核资源</strong></p>
<p>因此需要等待子进程的结束并获取子进程的返回信息：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>

<span class="token class-name">pid_t</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> stat_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">pid_t</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> stat_loc<span class="token punctuation">,</span> <span class="token keyword">int</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>wait</code> 函数将阻塞进程，直到该进程的某个子进程结束运行为止，因此不少服务器程序所期望的，而 <code>waitpid</code> 解决了这个问题</p>
<ul>
<li><code>pid</code> : 等待指定 pid 的子进程，若为 -1，就等待任意一个进程</li>
<li><code>stat_loc</code> : 保存子进程的退出信息，可以设置为 NULL</li>
<li><code>option</code> : 控制 <code>waitpid</code> 函数的行为，该参数最常用的取值是 <strong>WNOHANG</strong> ，它使得 <code>waitpid</code> 是非阻塞的，如果 pid 指定的目标子进程还没有结束或意外终止，则 <code>waitpid</code> 立即返回0，如果目标子进程确实正常退出了，则返回子进程 pid，调用失败时返回 -1 并设置 errno</li>
</ul>
<p>当子进程结束后会发出 <strong>SIGCHLD</strong> 信号，此时我们就可以在信号处理函数中调用 <code>waitpid</code> 函数以 “彻底结束” 一个子进程</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_child</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> stat<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* 对结束的子进程进行善后处理 */</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>



<h2 id="管道（父子进程间通信）"><a href="#管道（父子进程间通信）" class="headerlink" title="管道（父子进程间通信）"></a>管道（父子进程间通信）</h2><p>管道能在父、子进程间传递数据，利用的是 fork 调用之后两个管道文件描述符都保持打开，一对这样的文件描述符只能保证父、子进程间一个方向的数据传输，父进程和子进程都必须有一个关闭 <code>fd[0]</code> ，另一个关闭 <code>fd[1]</code> </p>
<p>显然，如果要实现父、子进程之间的双向数据传输，就必须使用两个管道，利用 <code>socketpair</code> .不过，<strong>管道只能用于有关联的两个进程间的通信</strong>，但是有一种特殊的管道 (FIFO 管道)也能用于无关联进程之间的通信</p>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>信号量（Semaphore）：有时被称为信号灯，是在多线程环境下使用的一种设施，可以用来保证两个或多个关键代码段不被并发调用。在进入一个关键代码段之前，线程必须获取一个信号量，一旦该关键代码完成了，那么该线程必须释放信号量。其它想进入该关键代码段的线程必须等待直到第一个线程释放信号量</p>
<h2 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h2><p>共享内存是最高效的 IPC 机制，因为它不涉及进程之前的任何数据传输，通常和其他进程间通信方式一起使用</p>
<h3 id="shmget-系统调用"><a href="#shmget-系统调用" class="headerlink" title="shmget 系统调用"></a>shmget 系统调用</h3><p><code>shmget</code> 系统调用创建一段新的共享内存，或者获取一段已经存在的共享内存：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h></span></span>

<span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>key</code> 参数是一个键值，用来标识一段<strong>全局唯一</strong>的共享内存</p>
<p><code>size</code> 参数指定共享内存的大小，单位是<strong>字节</strong>，如果是获取已经存在的共享内存，可以设为0</p>
<p><code>shmflg</code> 参数的使用与含义与 <code>semget</code> 系统调用的 <code>sem_flags</code> 参数相同，不过它支持两个额外的标志 <strong>SHM_HUGETLB</strong> 和 <strong>SHM_NORESERVE</strong> :</p>
<ul>
<li><strong>SHM_HUGETLB</strong> : 系统将使用”大页面”来为共享内存分配空间</li>
<li><strong>SHM_NORESERVE</strong> : 不为共享内存保留交换分区，这样，当物理内存不足的时候，对该共享内存执行写操作将触发 <strong>SIGSEGV</strong> 信号</li>
</ul>
<p>成功时返回一个正整数值，它是共享内存的标识符，失败时返回-1并设置 errno</p>
<h3 id="shmat-和-shmdt-系统调用"><a href="#shmat-和-shmdt-系统调用" class="headerlink" title="shmat 和 shmdt 系统调用"></a>shmat 和 shmdt 系统调用</h3><p>共享内存被创建/获取之后，我们不能立即访问它，而是需要先将它关联到进程的地址空间中。使用完共享内存之后，我们也需要将它从进程地址空间中分离。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h></span></span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shm_id<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> shm_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> shm_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>shm_id</code> 参数是由 <code>shmget</code> 调用返回的共享内存标识符</p>
<p><code>shm_addr</code> 参数指定将共享内存关联到进程的哪块地址空间（若为 <code>NULL</code> ，则被关联的地址由操作系统选择）</p>
<p><code>shmflg</code> 参数限制了对共享内存的相关操作</p>
<h3 id="shmctl-系统调用"><a href="#shmctl-系统调用" class="headerlink" title="shmctl 系统调用"></a>shmctl 系统调用</h3><p><code>shmctl</code> 系统调用控制共享内存的某些属性。定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h></span></span>

<span class="token comment">// 成功时的返回值取决于 command 参数</span>
<span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shm_id<span class="token punctuation">,</span> <span class="token keyword">int</span> command<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span><span class="token operator">*</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h3 id="共享内存的-POSIX-方法"><a href="#共享内存的-POSIX-方法" class="headerlink" title="共享内存的 POSIX 方法"></a>共享内存的 POSIX 方法</h3><p>Linux 提供了另外一种利用 <code>mmap</code> 在<strong>无关进程</strong>之间共享内存的方式，这种方式无须任何文件的支持，但它需要先使用如下函数来创建或打开一个 POSIX 共享内存对象</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">int</span> <span class="token function">shm_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> oflag<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>shm_open</code> 的使用方法与 <code>open</code> 系统调用完全相同</p>
<p><code>name</code> 参数指定要创建 / 打开的共享内存对象</p>
<p><code>oflag</code> 参数指定创建方式：</p>
<ul>
<li><strong>O_RDONLY</strong>：以只读方式打开共享内存对象</li>
<li><strong>O_RDWR</strong>：以可读、可写方式打开共享内存对象</li>
<li><strong>O_CREAT</strong>：如果共享内存对象不存在，则创建之</li>
<li><strong>O_EXCL</strong>：和 <strong>O_CREAT</strong> 一起使用，如果由 <code>name</code> 指定的共享内存对象已经存在，则 <code>shm_open</code> 调用返回错误，否则就创建一个新的共享内存对象</li>
</ul>
<p><code>shm_open</code> 调用成功时返回一个文件描述符，该文件描述符可用于后续的 <code>mmap</code> 调用，从而将共享内存关联到调用进程。失败时返回 -1， 并设置 errno</p>
<p>同样，由 <code>shm_open</code> 创建的共享内存对象使用完之后也需要被删除</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">shm_unlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>该参数将 <code>name</code> 参数指定的共享内存对象标记为等待删除，当所有使用该共享内存对象的进程都使用 <code>mummap</code> 将它从进程中分离之后，系统将销毁这个共享内存所占据的资源（注意：如果代码中使用了上述 POSIX 共享内存函数，则编译的时候需要指定链接选项 <code>-lrt</code> ）</p>
<p><strong>使用共享内存的聊天室服务器程序</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USER_LIMIT</span> <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FD_LIMIT</span> <span class="token expression"><span class="token number">65535</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENT_NUMBER</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PROCESS_LIMIT</span> <span class="token expression"><span class="token number">65536</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">client_data</span> <span class="token punctuation">&#123;</span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> connfd<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> shm_name <span class="token operator">=</span> <span class="token string">"/my_shm"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> sig_pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> epollfd<span class="token punctuation">;</span>
<span class="token keyword">int</span> listenfd<span class="token punctuation">;</span>
<span class="token keyword">int</span> shmfd<span class="token punctuation">;</span>

<span class="token keyword">char</span><span class="token operator">*</span> share_mem <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

client_data<span class="token operator">*</span> users <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

<span class="token keyword">int</span><span class="token operator">*</span> sub_process <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

<span class="token keyword">int</span> user_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
bool stop_child <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bool restart <span class="token operator">=</span> true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>restart<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">del_resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">shm_unlink</span><span class="token punctuation">(</span>shm_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    delete <span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
    delete <span class="token punctuation">[</span><span class="token punctuation">]</span> sub_process<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">child_term_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    stop_child <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">run_child</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">,</span> client_data<span class="token operator">*</span> users<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> share_mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> child_epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>child_epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> connfd <span class="token operator">=</span> users<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>connfd<span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>child_epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pipefd <span class="token operator">=</span> users<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>child_epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> child_term_handler<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_child<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>child_epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> connfd<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">memset</span><span class="token punctuation">(</span>share_mem <span class="token operator">+</span> idx <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> share_mem <span class="token operator">+</span> idx <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        stop_child <span class="token operator">=</span> true<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    stop_child <span class="token operator">=</span> true<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>idx<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 子进程接收父进程通过管道发来的信息</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> client <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        stop_child <span class="token operator">=</span> true<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    stop_child <span class="token operator">=</span> true<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">send</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> share_mem <span class="token operator">+</span> client <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>child_epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    user_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    users <span class="token operator">=</span> new client_data <span class="token punctuation">[</span>USER_LIMIT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    sub_process <span class="token operator">=</span> new <span class="token keyword">int</span> <span class="token punctuation">[</span>PROCESS_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> PROCESS_LIMIT<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sub_process<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sig_pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> sig_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> sig_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> sig_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> sig_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool stop_server <span class="token operator">=</span> false<span class="token punctuation">;</span>
    bool terminate <span class="token operator">=</span> false<span class="token punctuation">;</span>

    shmfd <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span>shm_name<span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>shmfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span>shmfd<span class="token punctuation">,</span> USER_LIMIT <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    share_mem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> USER_LIMIT <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> shmfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>share_mem <span class="token operator">!=</span> MAP_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>shmfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"epoll failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_address<span class="token punctuation">;</span>
                <span class="token class-name">socklen_t</span> client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"errno is: %d\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>user_count <span class="token operator">>=</span> USER_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> info <span class="token operator">=</span> <span class="token string">"too many users\n"</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">send</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 给想连接的客户发送信息</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>connfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">run_child</span><span class="token punctuation">(</span>user_count<span class="token punctuation">,</span> users<span class="token punctuation">,</span> share_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>share_mem<span class="token punctuation">,</span> USER_LIMIT <span class="token operator">*</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意要释放内存</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>user_count<span class="token punctuation">]</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> pid<span class="token punctuation">;</span>

                    sub_process<span class="token punctuation">[</span>pid<span class="token punctuation">]</span> <span class="token operator">=</span> user_count<span class="token punctuation">;</span>
                    user_count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> sig_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sig_pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">switch</span><span class="token punctuation">(</span>signals<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">case</span> SIGCHLD<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
                                    <span class="token keyword">int</span> stat<span class="token punctuation">;</span>
                                    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stat<span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                        <span class="token keyword">int</span> del_user <span class="token operator">=</span> sub_process<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                        sub_process<span class="token punctuation">[</span>pid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>del_user <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>del_user <span class="token operator">></span> USER_LIMIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">&#125;</span>

                                        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> users<span class="token punctuation">[</span>del_user<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token function">close</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>del_user<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        users<span class="token punctuation">[</span>del_user<span class="token punctuation">]</span> <span class="token operator">=</span> users<span class="token punctuation">[</span><span class="token operator">--</span>user_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                        sub_process<span class="token punctuation">[</span>users<span class="token punctuation">[</span>del_user<span class="token punctuation">]</span><span class="token punctuation">.</span>pid<span class="token punctuation">]</span> <span class="token operator">=</span> del_user<span class="token punctuation">;</span>
                                    <span class="token punctuation">&#125;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>terminate <span class="token operator">&amp;&amp;</span> user_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                        stop_server <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                    <span class="token punctuation">&#125;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span>
                            <span class="token keyword">case</span> SIGINT<span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"kill all the child now"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>user_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                        stop_server <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">&#125;</span>
                                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> user_count<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                        <span class="token keyword">int</span> pid <span class="token operator">=</span> users<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>pid<span class="token punctuation">;</span>
                                        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">&#125;</span>
                                    terminate <span class="token operator">=</span> true<span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token keyword">default</span><span class="token operator">:</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">int</span> child <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里没有传递实际的数据，而只是一个user_count下标，借此找到要读的共享内存段</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"read data from child accross pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> user_count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>users<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> sockfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"send data to child accross pipe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">send</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>child<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">del_resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
</code></pre>



<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><p>消息队列是在两个进程之间传递二进制块数据的一种简单有效的方式。每个数据块都有一个特定的类型，接收方可以根据类型来有选择的接收数据，而不一定像管道和命名管道那样必须以先进先出的方式接收数据</p>
<h3 id="msgget-系统调用"><a href="#msgget-系统调用" class="headerlink" title="msgget 系统调用"></a>msgget 系统调用</h3><p>创建一个消息队列，或者获取一个已有的消息队列。定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h></span></span>

<span class="token keyword">int</span> <span class="token function">msgget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>key</code> 参数是一个键值，用来标识一个全局唯一的消息队列</p>
<p><code>msgflg</code> 参数的使用含义与 <code>semget</code> 系统调用的 <code>sem_flags</code> 参数相同</p>
<h3 id="msgsnd-系统调用"><a href="#msgsnd-系统调用" class="headerlink" title="msgsnd 系统调用"></a>msgsnd 系统调用</h3><p>把一条消息添加到消息队列中。定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h></span></span>

<span class="token comment">// 成功时返回0, 失败时返回 -1 并设置 errno</span>
<span class="token keyword">int</span> <span class="token function">msgsnd</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> msg_ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msg_sz<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p><code>msqid</code> 参数是由 <code>msgget</code> 调用返回的消息队列标识符</p>
<p><code>msg_ptr</code> 参数指向一个准备发送的消息，消息必须被定义为如下类型：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">msgbuf</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> mtype<span class="token punctuation">;</span>	<span class="token comment">/* 消息类型, 必须是一个正整数 */</span>
    <span class="token keyword">char</span> mtext<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 消息数据 */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p><code>msgflg</code> 参数控制 <code>msgsnd</code> 的行为，它通常仅支持 <strong>IPC_NOWAIT</strong> 标志，即以非阻塞的方式发送消息。默认情况下，发送消息时如果消息队列满了，则 <code>msgsnd</code> 将阻塞。若此标志被指定，这立即返回并设置 errno 为 <strong>EAGAIN</strong></p>
<p>​    处于阻塞状态的 <code>msgsnd</code> 调用可能被如下两种异常情况所中断：</p>
<ul>
<li>消息队列被移除</li>
<li>程序接受到信号</li>
</ul>
<h3 id="msgrcv-系统调用"><a href="#msgrcv-系统调用" class="headerlink" title="msgrcv 系统调用"></a>msgrcv 系统调用</h3><p>从消息队列中获取消息。定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h></span></span>

<span class="token comment">// 成功时返回0, 失败则返回 -1 并设置 errno</span>
<span class="token keyword">int</span> <span class="token function">msgrcv</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> msg_ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msg_sz<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">int</span> msgtype<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h3 id="msgctl-系统调用"><a href="#msgctl-系统调用" class="headerlink" title="msgctl 系统调用"></a>msgctl 系统调用</h3><p>控制消息队列的某些属性。定义如下：</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h></span></span>

<span class="token comment">// msgctl 成功时的返回值取决于command 参数</span>
<span class="token keyword">int</span> <span class="token function">msgctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">int</span> command<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msqid_ds</span><span class="token operator">*</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h2 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h2><p>​    线程是程序中完成一个独立任务的完整执行序列，即一个可调度的实体。根据运行环境和调度者的身份，线程可分为<strong>内核线程</strong>和<strong>用户线程</strong> 。当进程的一个内核线程获得 CPU 的使用权时，它就加载并运行一个用户线程。</p>
<h3 id="POSIX-线程-API"><a href="#POSIX-线程-API" class="headerlink" title="POSIX 线程 API"></a>POSIX 线程 API</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token comment">// 1. 创建一个线程</span>
<span class="token comment">// pthread_t 是 unsigned long int 类型</span>
<span class="token comment">// attr 设置线程属性, 一般为 NULL</span>
<span class="token comment">// start_routine 是函数指针, 指向线程将要执行的任务</span>
<span class="token comment">// arg 是函数参数</span>
<span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span><span class="token operator">*</span> thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span><span class="token operator">*</span> attr<span class="token punctuation">,</span>
                   <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 2.线程结束(执行完之后不会反回到调用者, 而且永远不会失败)</span>
<span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.等待其它线程结束</span>
<span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4.异常终止一个线程</span>
<span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<ol>
<li><p>一个用户可以打开的线程数量不能超过软资源限制。此外，系统上所有用户能创建的线程总数也不得超过 <code>/proc/sys/kernel/threads-max</code> 内核参数所定义的值</p>
</li>
<li><p>线程函数在结束时最好调用此函数，以确保安全、干净地退出</p>
</li>
<li><p>注意这里传入的不是指针</p>
</li>
<li><p>该函数成功时返回0，失败则返回错误码</p>
</li>
</ol>
<h3 id="POSIX-信号量"><a href="#POSIX-信号量" class="headerlink" title="POSIX 信号量"></a>POSIX 信号量</h3><p>三种专门用于线程同步的机制：<strong>POSIX信号量</strong>、<strong>互斥量</strong>和<strong>条件变量</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h></span></span>

<span class="token comment">// 初始化信号量</span>
<span class="token comment">// 1. sem_t 变量</span>
<span class="token comment">// 2. pshared 为0表示这个信号量是当前进程的局部信号量, 否则该信号量可以在多个进程之间共享</span>
<span class="token comment">// 3. value 指定信号量初始值</span>
<span class="token keyword">int</span> <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span><span class="token operator">*</span> sem<span class="token punctuation">,</span> <span class="token keyword">int</span> pshared<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 销毁信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span><span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 以原子操作的方式将信号量的值减一。 减完后信号量的值若小于0，就等待至信号量大于等于0</span>
<span class="token keyword">int</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span><span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 始终立即返回, 当信号量为0时返回-1并设置errno</span>
<span class="token keyword">int</span> <span class="token function">sem_trywait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span><span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 原子地将信号量加一</span>
<span class="token keyword">int</span> <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span><span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h3 id="互斥锁基础-API"><a href="#互斥锁基础-API" class="headerlink" title="互斥锁基础 API"></a>互斥锁基础 API</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_mutexattr_t</span><span class="token operator">*</span> mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h3 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>

<span class="token keyword">int</span> <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span><span class="token operator">*</span> cond<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_condattr_t</span><span class="token operator">*</span> cond_attr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span><span class="token operator">*</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 相当于c++的 notify_all()</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span><span class="token operator">*</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 相当于c++的 notify_one()</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span><span class="token operator">*</span> cond<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span><span class="token operator">*</span> cond<span class="token punctuation">,</span> <span class="token class-name">pthread_mutex_t</span><span class="token operator">*</span> mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>



<h3 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h3><p>多线程环境下，<strong>子进程只拥有一个执行线程</strong>，它是调用 <code>fork</code> 的那个线程的完整复制。并且<strong>子进程将自动继承父进程中互斥锁（条件变量与之类似）的状态</strong>。这就引起了一个问题：子进程可能不清楚从父进程继承而来的互斥锁的具体状态。这个互斥锁可能被加锁了，但并不是由调用 <code>fork</code> 函数的那个线程锁住的，而是由其它线程锁住的。如果是这种情况，则子进程若再次对该互斥锁执行加锁操作就会导致<strong>死锁</strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:xukeawsl@gmail.com">NumPy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://xukeawsl.gitee.io/2022/05/16/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/">https://xukeawsl.gitee.io/2022/05/16/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/socket/">socket</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/05/16/frVxQGFPMW6UtpI.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/24/gdb%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="https://s2.loli.net/2022/09/24/AFD3YCpyntiSweE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">gdb笔记</div></div></a></div><div class="next-post pull-right"><a href="/2022/02/28/MySQL%E7%AC%94%E8%AE%B0/"><img class="next-cover" src="https://s2.loli.net/2022/02/28/a2HsQGWDpOkJvUg.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MySQL笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/11/23/kxpMnNjGaOhZews.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">NumPy</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">10</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xukeawsl/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/xukeawsl" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xukeawsl@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">网络编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv4-%E5%A5%97%E6%8E%A5%E5%AD%97%E5%9C%B0%E5%9D%80%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">IPv4 套接字地址结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%A5%97%E6%8E%A5%E5%AD%97%E5%9C%B0%E5%9D%80%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">通用套接字地址结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPv6-%E5%A5%97%E6%8E%A5%E5%AD%97%E5%9C%B0%E5%9D%80%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">IPv6 套接字地址结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E7%9A%84%E9%80%9A%E7%94%A8%E5%A5%97%E6%8E%A5%E5%AD%97%E5%9C%B0%E5%9D%80%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">新的通用套接字地址结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%BC-%E7%BB%93%E6%9E%9C%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">值-结果参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E6%8E%92%E5%BA%8F%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">字节排序函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E6%93%8D%E7%BA%B5%E5%87%BD%E6%95%B0"><span class="toc-number">1.7.</span> <span class="toc-text">字节操纵函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inet-aton%E3%80%81inet-addr-%E5%92%8C-inet-ntoa-%E5%87%BD%E6%95%B0"><span class="toc-number">1.8.</span> <span class="toc-text">inet_aton、inet_addr 和 inet_ntoa 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inet-pton-%E5%92%8C-inet-ntop-%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.</span> <span class="toc-text">inet_pton 和 inet_ntop 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sock-ntop-%E5%92%8C%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.</span> <span class="toc-text">sock_ntop 和相关函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readn%E3%80%81writen-%E5%92%8C-readline-%E5%87%BD%E6%95%B0"><span class="toc-number">1.11.</span> <span class="toc-text">readn、writen 和 readline 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC-TCP-%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B"><span class="toc-number">1.12.</span> <span class="toc-text">基本 TCP 套接字编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#socket-%E5%87%BD%E6%95%B0"><span class="toc-number">1.13.</span> <span class="toc-text">socket 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#connect-%E5%87%BD%E6%95%B0"><span class="toc-number">1.14.</span> <span class="toc-text">connect 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bind-%E5%87%BD%E6%95%B0"><span class="toc-number">1.15.</span> <span class="toc-text">bind 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#listen-%E5%87%BD%E6%95%B0"><span class="toc-number">1.16.</span> <span class="toc-text">listen 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#accept-%E5%87%BD%E6%95%B0"><span class="toc-number">1.17.</span> <span class="toc-text">accept 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#close-%E5%87%BD%E6%95%B0"><span class="toc-number">1.18.</span> <span class="toc-text">close 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fork-%E5%92%8C-exec-%E5%87%BD%E6%95%B0"><span class="toc-number">1.19.</span> <span class="toc-text">fork 和 exec 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.20.</span> <span class="toc-text">并发服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.21.</span> <span class="toc-text">僵尸进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wait-%E5%92%8C-waitpid-%E5%87%BD%E6%95%B0"><span class="toc-number">1.22.</span> <span class="toc-text">wait 和 waitpid 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A3%E7%A0%81%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.23.</span> <span class="toc-text">并发服务器代码模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.24.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getsockname-%E5%92%8C-getpeername-%E5%87%BD%E6%95%B0"><span class="toc-number">1.25.</span> <span class="toc-text">getsockname 和 getpeername 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#recv-%E5%92%8C-send%E5%87%BD%E6%95%B0"><span class="toc-number">1.26.</span> <span class="toc-text">recv 和 send函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gethostbyname-%E5%92%8C-gethostbyaddr-%E5%87%BD%E6%95%B0"><span class="toc-number">1.27.</span> <span class="toc-text">gethostbyname 和 gethostbyaddr 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getservbyname-%E5%92%8C-getservbyport"><span class="toc-number">1.28.</span> <span class="toc-text">getservbyname 和 getservbyport</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7-I-O-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.</span> <span class="toc-text">高级 I&#x2F;O 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.1.</span> <span class="toc-text">pipe 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socketpair-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.2.</span> <span class="toc-text">socketpair 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dup-%E5%87%BD%E6%95%B0%E5%92%8C-dup2-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.3.</span> <span class="toc-text">dup 函数和 dup2 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readv-%E5%87%BD%E6%95%B0%E5%92%8C-writev-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.4.</span> <span class="toc-text">readv 函数和 writev 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sendfile-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.5.</span> <span class="toc-text">sendfile 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap-%E5%87%BD%E6%95%B0%E5%92%8C-munmap-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.6.</span> <span class="toc-text">mmap 函数和 munmap 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#splice-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.7.</span> <span class="toc-text">splice 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tee-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.8.</span> <span class="toc-text">tee 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fcntl-%E5%87%BD%E6%95%B0"><span class="toc-number">1.29.9.</span> <span class="toc-text">fcntl 函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-O%E5%A4%8D%E7%94%A8"><span class="toc-number">1.30.</span> <span class="toc-text">I&#x2F;O复用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#select-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.30.1.</span> <span class="toc-text">select 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poll-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.30.2.</span> <span class="toc-text">poll 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#epoll-%E7%B3%BB%E5%88%97%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.30.3.</span> <span class="toc-text">epoll 系列系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%BA%8B%E4%BB%B6%E8%A1%A8"><span class="toc-number">1.30.3.1.</span> <span class="toc-text">内核事件表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#epoll-wait-%E5%87%BD%E6%95%B0"><span class="toc-number">1.30.3.2.</span> <span class="toc-text">epoll_wait 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LT-%E5%92%8C-ET-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.30.3.3.</span> <span class="toc-text">LT 和 ET 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EPOLLONESHOT-%E4%BA%8B%E4%BB%B6"><span class="toc-number">1.30.3.4.</span> <span class="toc-text">EPOLLONESHOT 事件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.31.</span> <span class="toc-text">信号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.31.1.</span> <span class="toc-text">发送信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-number">1.31.2.</span> <span class="toc-text">信号处理方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.31.3.</span> <span class="toc-text">中断系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#signal-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.31.4.</span> <span class="toc-text">signal 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sigaction-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.31.5.</span> <span class="toc-text">sigaction 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%9B%86%E5%87%BD%E6%95%B0"><span class="toc-number">1.31.6.</span> <span class="toc-text">信号集函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BF%A1%E5%8F%B7%E6%8E%A9%E7%A0%81"><span class="toc-number">1.31.7.</span> <span class="toc-text">进程信号掩码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A2%AB%E6%8C%82%E8%B5%B7%E7%9A%84%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.31.8.</span> <span class="toc-text">被挂起的信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E4%BA%8B%E4%BB%B6%E6%BA%90"><span class="toc-number">1.31.9.</span> <span class="toc-text">统一事件源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.31.10.</span> <span class="toc-text">网络编程相关信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.32.</span> <span class="toc-text">定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket-%E9%80%89%E9%A1%B9-SO-RCVTIMEO-%E5%92%8C-SO-SNDTIMEO"><span class="toc-number">1.32.1.</span> <span class="toc-text">socket 选项 SO_RCVTIMEO 和 SO_SNDTIMEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SIGALRM-%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.32.2.</span> <span class="toc-text">SIGALRM 信号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8D%87%E5%BA%8F%E9%93%BE%E8%A1%A8%E7%9A%84%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.32.2.1.</span> <span class="toc-text">基于升序链表的定时器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.32.2.2.</span> <span class="toc-text">处理非活动连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">1.32.3.</span> <span class="toc-text">高性能定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E8%BD%AE"><span class="toc-number">1.32.3.1.</span> <span class="toc-text">时间轮</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A0%86"><span class="toc-number">1.32.3.2.</span> <span class="toc-text">时间堆</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="toc-number">1.33.</span> <span class="toc-text">多进程编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fork-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.33.1.</span> <span class="toc-text">fork 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.33.2.</span> <span class="toc-text">处理僵尸进程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%EF%BC%88%E7%88%B6%E5%AD%90%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%89"><span class="toc-number">1.34.</span> <span class="toc-text">管道（父子进程间通信）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">1.35.</span> <span class="toc-text">信号量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">1.36.</span> <span class="toc-text">共享内存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shmget-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.36.1.</span> <span class="toc-text">shmget 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shmat-%E5%92%8C-shmdt-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.36.2.</span> <span class="toc-text">shmat 和 shmdt 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shmctl-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.36.3.</span> <span class="toc-text">shmctl 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84-POSIX-%E6%96%B9%E6%B3%95"><span class="toc-number">1.36.4.</span> <span class="toc-text">共享内存的 POSIX 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.37.</span> <span class="toc-text">消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#msgget-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.37.1.</span> <span class="toc-text">msgget 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.37.2.</span> <span class="toc-text">msgsnd 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msgrcv-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.37.3.</span> <span class="toc-text">msgrcv 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msgctl-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.37.4.</span> <span class="toc-text">msgctl 系统调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="toc-number">1.38.</span> <span class="toc-text">多线程编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POSIX-%E7%BA%BF%E7%A8%8B-API"><span class="toc-number">1.38.1.</span> <span class="toc-text">POSIX 线程 API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POSIX-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-number">1.38.2.</span> <span class="toc-text">POSIX 信号量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81%E5%9F%BA%E7%A1%80-API"><span class="toc-number">1.38.3.</span> <span class="toc-text">互斥锁基础 API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">1.38.4.</span> <span class="toc-text">条件变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.38.5.</span> <span class="toc-text">进程和线程</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/22/Nginx%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" title="Nginx原子操作"><img src="https://s2.loli.net/2023/06/04/xNRnJCVFOkhDfM6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx原子操作"/></a><div class="content"><a class="title" href="/2023/10/22/Nginx%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" title="Nginx原子操作">Nginx原子操作</a><time datetime="2023-10-22T06:08:13.000Z" title="Created 2023-10-22 14:08:13">2023-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/22/Nginx%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/" title="Nginx共享内存"><img src="https://s2.loli.net/2023/06/04/xNRnJCVFOkhDfM6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx共享内存"/></a><div class="content"><a class="title" href="/2023/10/22/Nginx%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/" title="Nginx共享内存">Nginx共享内存</a><time datetime="2023-10-22T06:08:04.000Z" title="Created 2023-10-22 14:08:04">2023-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/15/Nginx%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F/" title="Nginx内部变量"><img src="https://s2.loli.net/2023/06/04/xNRnJCVFOkhDfM6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx内部变量"/></a><div class="content"><a class="title" href="/2023/10/15/Nginx%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F/" title="Nginx内部变量">Nginx内部变量</a><time datetime="2023-10-15T09:39:02.000Z" title="Created 2023-10-15 17:39:02">2023-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/04/Nginx%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94%E8%A7%A3%E5%86%B3/" title="Nginx惊群效应解决"><img src="https://s2.loli.net/2023/06/04/xNRnJCVFOkhDfM6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx惊群效应解决"/></a><div class="content"><a class="title" href="/2023/10/04/Nginx%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94%E8%A7%A3%E5%86%B3/" title="Nginx惊群效应解决">Nginx惊群效应解决</a><time datetime="2023-10-04T02:21:35.000Z" title="Created 2023-10-04 10:21:35">2023-10-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/10/Nginx%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" title="Nginx开发指南"><img src="https://s2.loli.net/2023/06/04/xNRnJCVFOkhDfM6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx开发指南"/></a><div class="content"><a class="title" href="/2023/09/10/Nginx%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" title="Nginx开发指南">Nginx开发指南</a><time datetime="2023-09-10T08:14:57.000Z" title="Created 2023-09-10 16:14:57">2023-09-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2022/05/16/qucopzeACxrjSik.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By NumPy</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>